---
layout: post
title: 单元测试：JUnit与PowerMockito的实践与应用
author: zrg
description: 单元测试是针对最下可测试单元的测试，可以测试方法，所测试单元与外界的依赖应该尽可能为0。
excerpt: 
comments: true
categories: 
- 质量保障
tags:
- 单元测试
- Unit Testing
- JUnit
- Mockito
- PowerMockito
---

<p>
My email address: zrg1390556486@gmail.com
</p>


<div id="outline-container-orgc80f80e" class="outline-2">
<h2 id="orgc80f80e"><span class="section-number-2">1.</span> 单元测试概述</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgceff5a8" class="outline-3">
<h3 id="orgceff5a8"><span class="section-number-3">1.1.</span> 什么是单元测试？</h3>
<div class="outline-text-3" id="text-1-1">
<p>
单元测试（unit testing），是指对软件中的最小可测试单元进行检查和验证。
<br />
单元测试是在软件开发过程中要进行的最低级别的测试活动，软件的独立单元将在与程序的其他部分相隔离的情况下进行测试。
</p>
</div>
</div>
<div id="outline-container-org6723b7f" class="outline-3">
<h3 id="org6723b7f"><span class="section-number-3">1.2.</span> 为什么要写单元测试？</h3>
<div class="outline-text-3" id="text-1-2">
<p>
随着 DevOps、敏捷、微服务的发展，产品的迭代速度越来越快，“速度” 与 “质量” 经常被视为互相矛盾点。由于业务逐渐服务化，导致微服务野蛮生长。企业在实施传统的分层自动化测试也由 “金字塔模型” 转变为 “橄榄球模型”，如下图所示。由于 UI、API 自动化测试都需要依赖被测系统正常运行，且经常出现由于测试数据、环境 (前端、后端) 部署、用例依赖等原因导致自动化测试执行失败。即使环境正常的情况下由于测试用例的数量由开始的核心场景覆盖延伸到各个分支覆盖，数量成几何指数的倍增，带来了测试用例执行失败定位问题极为困难。基于这种背景下衍生出了对 “分层自动化测试” 更加深入的思考。
</p>

<div id="org86335eb" class="figure">
<p><img src="{{site.url}}/assets/images/test/auto-testing-pyramid.png" alt="auto-testing-pyramid.png" />
</p>
<p><span class="figure-number">Figure 1: </span>金字塔模型-&gt;橄榄球模型</p>
</div>

<p>
金字塔模型中指出自动化测试策略应该首先将更多的测试投入到底层 “单元测试”，其次是 “集成测试”，最后是 “端到端测试”。然而当前微服务现状中，企业将自动化测试更多放在 “集成测试 (API 测试)” 环节，这也是接口测试最近几年爆发式增长原因之一。
</p>
<p>
<img src="{{site.url}}/assets/images/test/auto-testing-pyramid-bug.png" alt="auto-testing-pyramid-bug.png" />
从 “缺陷的产生率” 倒三角模型来看，缺陷更多产生在 “单元级别”，而且在单元级别修复缺陷的成本更低、效率更高。通过从单元层面消灭缺陷使得 “集成/端到端测试” 缺陷会明显减少，而且排查问题的效率也更。特别是当需要对代码模块进行重构或重新设计时单元测试是保证质量的最重要手段之一。从单元级别解决缺陷是最快的反馈机制，执行效率也最高，结合 “测试替身 (Test Double)” 等技术进行依赖的隔离能降低单元之间的依赖性，提高测试用例的执行成功率，使得持续测试变为可能。
</p>


<div id="org457f75c" class="figure">
<p><img src="{{site.url}}/assets/images/test/unit-test-3.png" alt="unit-test-3.png" />
</p>
<p><span class="figure-number">Figure 2: </span>自动化测试金字塔</p>
</div>
<dl class="org-dl">
<dt>UI/端到端测试(UI/End-to-End testing)</dt><dd>UI 测试适用于确保用户界面的正确性和功能性，它主要关注用户交互和界面元素的行为，成熟的自动化工具有QTP、Selenium、微信小程序自动化框架minium；端到端测试(E2E)也被称为功能测试(Functional Testing)，用于模拟真实用户场景，将整个系统作为一个整体，然后从用户的角度进行测试的，测试应用程序的整个流程。端到端测试的目的是测试系统在实际使用的是否正常的, 因此通常来说是不需要测试替身的(Test Double)。UI 测试主要关注用户界面的正确性和功能性，而端到端测试关注整个应用程序的各个界面和组件之间的交互。
<ul class="org-ul">
<li>UI测试通常涉及以下方面:
<ul class="org-ul">
<li>验证用户界面元素是否正确显示和布局，例如按钮、文本框、下拉菜单等。</li>
<li>验证用户输入是否能够正确处理和响应，例如通过输入文本后是否能够正确搜索或提交表单。</li>
<li>验证用户界面上的交互是否按预期工作，例如点击按钮后是否触发正确的操作。</li>
</ul></li>
<li>端到端测试通常涉及以下方面：
<ul class="org-ul">
<li>验证用户界面的正确性和功能性，类似于UI测试。</li>
<li>验证后端服务和数据库的正确性，例如数据的读写操作是否正常。</li>
<li>验证整个应用程序的各个模块和组件之间的交互是否按预期工作。</li>
</ul></li>
</ul></dd>
<dt>集成/接口测试(Integration/Interface testing)</dt><dd>集成/接口测试是现在在企业中应用最广泛的自动化测试之一，它的优点在于规避了UI层自动化测试的缺点，一旦形成较为稳定、完整的框架后基本上是比较通用的，并且接口测试关注的重点更多在于数据（数据处理、数据状态、数据传递），不论是在Web端还是移动端都可以使用。缺点也很明显，就是对测试工程师的编码能力要求较高，一般接口自动化测试都会用Python、Java等语言开发。</dd>
<dt>单元测试(Unit testing)</dt><dd>单元测试关注的重点更多在于代码的实现与内部逻辑关系。对于不同产品的开发技术栈，都会有对应的单元测试框架，如Java有JUnit、testNG，C#有NUnit，Python有UnitTest、Pytest等。基本上可以肯定的是，单元测试是成本最低的，也是最容易推广，见效最大的。</dd>
</dl>
<p>
<br />
关于分层自动化测试的更多内容，在<a href="#orge485e12">附录A-分层自动化测试</a>中查看。
</p>
</div>
<div id="outline-container-org1b1a883" class="outline-4">
<h4 id="org1b1a883"><span class="section-number-4">1.2.1.</span> 单元测试的好处</h4>
<div class="outline-text-4" id="text-1-2-1">
<pre class="example">
使用单元测试可以有效地降低程序出错的机率，提供准确的文档，并帮助我们改进设计方案等等。
</pre>

<ul class="org-ul">
<li>允许你对代码做出任何改变，因为你了解单元测试会在你的预期之中。</li>
<li>单元测试可以有效地降低程序出现BUG的机率。</li>
<li>帮助你更深入地理解代码&#x2013;因为在写单元测试的时候，你需要明确程序所有的执行流程及对应的执行结果等等。</li>
<li>允许在任何时候代码重构，而不必担心破坏现有的代码。这使得我们编写程序更灵活。</li>
<li>确保你的代码的健壮性，因为所有的测试都是通过了的。</li>
<li>文档记录。单元测试就是一种无价的文档，它是展示函数或类如何使用的最佳文档，这份文档是可编译、可运行的、并且它保持最新，永远与代码同步。</li>
<li><b>具有回归性</b>::自动化的单元测试避免了代码出现回归，编写完成之后，可以随时随地地快速运行测试，而不是将代码部署到设备之后，然后再手动地覆盖各种执行路径，这样的行为效率低下，浪费时间。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org998d023" class="outline-3">
<h3 id="org998d023"><span class="section-number-3">1.3.</span> 什么时候写单元测试？</h3>
<div class="outline-text-3" id="text-1-3">
<p>
写单元测试的三种时机：
</p>
<ul class="org-ul">
<li>一是在具体实现代码之前，这是测试驱动开发（TDD）所提倡的。</li>
<li>二是与具体实现代码同步进行。先写少量功能代码，紧接着写单元测试（重复这两个过程，直到完成功能代码开发）。其实这种方案跟第一种已经很接近，基本上功能代码开发完，单元测试也差不多完成了。</li>
<li>三是编写完功能代码再写单元测试。根据实践经验，事后编写的单元测试“粒度”都比较粗。</li>
</ul>
<p>
<b>推荐单元测试与具体实现代码同步进行。</b>
</p>
</div>
</div>
<div id="outline-container-org077fda4" class="outline-3">
<h3 id="org077fda4"><span class="section-number-3">1.4.</span> 单元测试要写多细？</h3>
<div class="outline-text-3" id="text-1-4">
<p>
单元测试不是越多越好，而是越有效越好！需要有单元测试覆盖的地方：
</p>
<ul class="org-ul">
<li>逻辑复杂的</li>
<li>容易出错的</li>
<li>不易理解的，即使是自己过段时间也会遗忘的，看不懂自己的代码，单元测试代码有助于理解代码的功能和需求</li>
<li>公共代码。比如自定义的所有http请求都会经过的拦截器；工具类等。</li>
<li>核心业务代码。一个产品里最核心最有业务价值的代码应该要有较高的单元测试覆盖率。</li>
</ul>
</div>

<div id="outline-container-org7fa1cd9" class="outline-4">
<h4 id="org7fa1cd9"><span class="section-number-4">1.4.1.</span> 单元测试的覆盖率</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
单测覆盖率是指业务代码被单测测试的比例和程度，它是衡量单元测试好坏的一个很重要的指标，各类覆盖率指标从粗到细、从弱到强排列如下
</p>
<ul class="org-ul">
<li>粗粒度的覆盖：包括类覆盖和方法覆盖两种。</li>
<li>细粒度的覆盖：
<ul class="org-ul">
<li>分支覆盖（Branch Coverage )：分支覆盖率的计算公式中的分子是代码中被执行到的分支数，分母是代码中所有分支的 总数。</li>
<li>条件判定覆盖（Condition Decision Coverage）：条件判定覆盖要求设计足够的测试用例，能够让判定中每个条件的所有可能情况 至少被执行一次， 同时每个判定本身的所有可能结果也至少执行一次。</li>
<li>条件组合覆盖( Multiple Condition Coverage)：条件组合覆盖是指判定中所有条件的各种组合情况都出现至少一次。</li>
<li>路径覆盖( Path Coverage )：路径覆盖要求能够测试到程序中所有可能的路径。</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgce0eeee" class="outline-3">
<h3 id="orgce0eeee"><span class="section-number-3">1.5.</span> 单元测试相关概念</h3>
<div class="outline-text-3" id="text-1-5">

<div id="org10cd3a2" class="figure">
<p><img src="{{site_url}}/assets/images/test/unit-testing-sut.png" alt="unit-testing-sut.png" />
</p>
</div>
</div>
<div id="outline-container-org352b9b8" class="outline-4">
<h4 id="org352b9b8"><span class="section-number-4">1.5.1.</span> 四阶段测试模式</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
上图中左侧部分表示四阶段测试模式：Setup - Exercise - Verify - Teardown
</p>
<ol class="org-ol">
<li>Setup :: 测试准备阶段（Fixture Setup），准备测试所依赖的外部环境（例如被测类要读写文件，就先在文件系统中创建这个文件，必要时还写入特定的内容），创建被测类（System Under Test，简称 SUT）的实例，设置被测类的内部状态，注入它的外部依赖（一般用测试替身替代），等等。一句话：为测试的执行满足各种内外条件，使被测系统（SUT）和环境达到一个确定的状态（称为 Fixture）。</li>
<li>Exercise :: 执行测试阶段（exercise SUT），与被测类（SUT）交互，执行测试。</li>
<li>Verify :: 结果验证阶段（Result verification），验证测试的结果是否符合方方面面的预期：方法的返回值是否和我们的期望值相同？SUT 的内部状态是否更新到我们期望的值？是否向文件或数据库写入了预期的数据？是否按照契约调用了外部依赖的指定方法？等等。</li>
<li>Teardown :: 环境清理阶段（Fixture teardown），在这个阶段将系统和环境恢复到测试前的状态--<b>测试不应该对系统和环境造成持久性的改变</b> ，包括：从数据库中删除测试插入的数据，从文件系统删除测试创建的文件，将修改了的数据行恢复原状等等。</li>
</ol>
<p>
<br />
<i>下面对图中右侧部分做详细介绍。</i>
</p>
</div>
</div>

<div id="outline-container-orgbfd7c2a" class="outline-4">
<h4 id="orgbfd7c2a"><span class="section-number-4">1.5.2.</span> 被测系统(SUT)</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
被测系统(System under test, SUT)表示正在被测试的系统, 目的是测试系统能否正确操作. 根据测试类型的不同, SUT 指代的内容也不同, 例如 SUT 可以是一个类甚至是一整个系统。
</p>
</div>
</div>
<div id="outline-container-orgd802522" class="outline-4">
<h4 id="orgd802522"><span class="section-number-4">1.5.3.</span> 测试依赖组件(DOC)</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
被测系统所依赖的组件, 例如进程 UserService 的单元测试时, UserService 会依赖 UserDao, 因此 UserDao 就是 DOC。
<br />
</p>
<dl class="org-dl">
<dt><b>SUT &amp; DOC</b></dt><dd>在做单元测试的时候，测试对象是SUT，但因为SUT会呼叫其他物件，使得SUT相依于DOC。
<br />
换句话说，要测试SUT，DOC也必须存在，这使得测试变得更复杂。例如，请参考下图的观察者设计模式（Observer Pattern），假设要测试Subject的notify函数，因此Subject的notify函数是SUT，Observer是DOC（因为notify函数会呼叫Observer的update函数）。 notify函数所影响的对象是Observer，透过测试notify无法直接观察到Observer的update函数是否有真的被呼叫，这样的相依性使得测试notify变得困难。
<img src="{{site_url}}/assets/images/unit-testing-observer-design-pattern.png" alt="unit-testing-observer-design-pattern.png" /></dd>
</dl>
</div>
</div>
<div id="outline-container-org01fb34f" class="outline-4">
<h4 id="org01fb34f"><span class="section-number-4">1.5.4.</span> 测试替身(Test Double)</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
一个实际的系统会依赖多个外部对象, 但是在进行单元测试时, 我们会用一些功能较为简单的并且其行为和实际对象类似的假对象来作为 SUT 的依赖对象, 以此来降低单元测试的复杂性和可实现性，在这里, 这些假对象就被称为测试替身(Test Double)。测试替身有如下 5 种类型：
</p>
<dl class="org-dl">
<dt>Test stub</dt><dd>为 SUT 提供数据的假对象。具体举例：假设我们的一个模块需要从 HTTP 接口中获取商品价格数据, 这个获取数据的接口被封装为 getPrice 方法. 在对这个模块进行测试时, 我们显然不太可能专门开一个 HTTP 服务器来提供此接口, 而是提供一个带有 getPrice 方法的假对象, 从这个假对象中获取数据. 在这个例子中, 提供数据的假对象就叫做 Test stub。</dd>
<dt>Fake object</dt><dd>实现了简单功能的一个假对象。Fake object 和 Test stub 的主要区别就是 Test stub 侧重于用于提供数据的假对象, 而 Fake object 没有这层含义。使用 Fake object 的最主要的原因就是在测试时某些组件不可用或运行速度太慢, 因而使用 Fake object 来代替它们。</dd>
<dt>Mock object</dt><dd>用于模拟实际的对象, 并且能够校验对这个 Mock object 的方法调用是否符合预期。Mock object 是 Test stub 或 Fake object 一种, 但是 Mock object 有 Test stub/Fake object 没有的特性, Mock object 可以很灵活地配置所调用的方法所产生的行为, 并且它可以追踪方法调用, 例如一个 Mock Object 方法调用时传递了哪些参数, 方法调用了几次等。</dd>
<dt>Dummy object</dt><dd>在测试中并不使用的, 但是为了测试代码能够正常编译/运行而添加的对象。 例如我们调用一个 Test Double 对象的一个方法, 这个方法需要传递几个参数, 但是其中某个参数无论是什么值都不会影响测试的结果, 那么这个参数就是一个 Dummy object. Dummy object 可以是一个空引用, 一个空对象或者是一个常量等。
<br />
简单的说, Dummy object 就是那些没有使用到的, 仅仅是为了填充参数列表的对象。</dd>
<dt>Test Spy</dt><dd>可以包装一个真实的 Java 对象, 并返回一个包装后的新对象。若没有特别配置的话, 对这个新对象的所有方法调用, 都会委派给实际的 Java 对象。
<br />
<b><b>mock 和 spy 的区别</b></b> 是：mock 是无中生有地生出一个完全虚拟的对象, 它的所有方法都是虚拟的; 而 spy 是在现有类的基础上包装了一个对象, 即如果我们没有重写 spy 的方法, 那么这些方法的实现其实都是调用的被包装的对象的方法。</dd>
</dl>
</div>
</div>
<div id="outline-container-org4d85381" class="outline-4">
<h4 id="org4d85381"><span class="section-number-4">1.5.5.</span> Test Fixture</h4>
<div class="outline-text-4" id="text-1-5-5">
<p>
所谓 test fixture, 就是运行测试程序所需要的先决条件(precondition)。即对被测对象进行测试时锁需要的一切东西(The test fixture is everything we need to have in place to exercise the SUT)。不单单指的是数据, 同时包括对被测对象的配置, 被测对象所需要的依赖对象等。JUnit4 通过 setUp 方法完成。
</p>
</div>
</div>
<div id="outline-container-org0e1fa3a" class="outline-4">
<h4 id="org0e1fa3a"><span class="section-number-4">1.5.6.</span> 测试用例(Test Case)</h4>
<div class="outline-text-4" id="text-1-5-6">
<p>
JUnit4 只要在每个测试方法标注 @Test 注解。
</p>
</div>
</div>
<div id="outline-container-org895e2b0" class="outline-4">
<h4 id="org895e2b0"><span class="section-number-4">1.5.7.</span> 测试套件(Test Suite)</h4>
<div class="outline-text-4" id="text-1-5-7">
<p>
通过@RunWith 和@SuteClass 两个注解, 我们可以创建一个测试套件。通过@RunWith 指定一个特殊的运行器，并通过@SuiteClasses 注解, 将需要进行测试的类列表作作为参数传入。
</p>
</div>
</div>
</div>
<div id="outline-container-orgd50e250" class="outline-3">
<h3 id="orgd50e250"><span class="section-number-3">1.6.</span> 流行的测试框架</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Java中存在很多单元测试框架，每种框架有着自己独特的特点，目前主流的测试框架有且不仅有以下几种：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">框架</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">JUnit</td>
<td class="org-left">JUnit 是 Java 中最常用的单元测试框架。该框架提供了丰富的测试与断言方法，例如：assertNull、assertTrue、assertEquals等，使用方法比较简单。JUnit 目前已经更新到 JUnit5 版本，该版本的新特性，例如：动态测试，依赖注入等，使得该框架更为健壮。</td>
</tr>

<tr>
<td class="org-left">TestNG</td>
<td class="org-left">TestNG 是Java中的另一种测试框架，集团内使用的较为小众。该框架较JUnit相比，功能更加强大，提供了更多的高级特性，例如：测试套件、数据驱动测试、依赖测试、并行测试等。在更复杂的测试场景（如参数化测试、依赖测试等）中，TestNG的表现更加优异。</td>
</tr>

<tr>
<td class="org-left">Spock</td>
<td class="org-left">Spock是基于Groovy语言编写的测试框架，该框架可以用来测试Java和Groovy的代码程序。Spock用来写测试代码的语言十分优美、表达力强，这一优点大大提高了测试代码的可读性和可维护性。Spock框架融合了JUnit、jMock、RSpec、Groovy、Scala和Vulcans等多种框架和语言的优点，旨在提供一套强大的测试平台。</td>
</tr>

<tr>
<td class="org-left">Mockito</td>
<td class="org-left">Mockito不是一个完整的单元测试框架，而是专注于mock对象的创建、验证。它通常与JUnit或TestNG结合使用来简化对复杂依赖的测试。</td>
</tr>

<tr>
<td class="org-left">EasyMock</td>
<td class="org-left">EasyMock是一套通过简单方法对于给定的接口生成mock对象的类库，通过使用Java代理机制动态生成模拟对象。该框架提供对接口的模拟，能够通过录制、回放、检查三步来完成大体的测试过程，可以验证方法的调用种类、次数、顺序等，还可以令mock对象返回指定的值或抛出指定异常。开发者通过EasyMock可以方便的构造mock对象而忽略对象背后真正的业务逻辑。一般情况下，EasyMock与JUnit或TestNG配合使用。</td>
</tr>

<tr>
<td class="org-left">PowerMock</td>
<td class="org-left">PowerMock是一种用于Java单元测试的框架，它扩展了其他mocking框架的能力，比如EasyMock和Mockito。PowerMock的主要特点是它可以mock静态方法、私有方法、final方法、构造函数，甚至系统类（如System、String等），这些通常是传统mocking框架所做不到的。虽然PowerMock提供了强大的功能，但由于它修改了类加载器和字节码操作，可能会导致一些测试方法与JVM或第三方库之间的兼容性问题。所以，在使用PowerMock时需要权衡其提供的功能和可能带来的复杂性。</td>
</tr>

<tr>
<td class="org-left">JMock</td>
<td class="org-left">JMock是一种用于Java单元测试的框架，属于一种轻量级框架，该框架采用了行为驱动开发（BDD）的测试风格。用来在单元测试中mock接口或类的依赖项，对代码进行隔离测试，而无需关心整个系统的其他部分。JMock支持通过声明式的方式来指定对象间的交互行为。</td>
</tr>

<tr>
<td class="org-left">Spring Test &amp; Spring Boot Test</td>
<td class="org-left">Spring Boot 应用程序功能集成化测试支持。</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-org10a6f04" class="outline-2">
<h2 id="org10a6f04"><span class="section-number-2">2.</span> 单元测试框架</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgbe0c005" class="outline-3">
<h3 id="orgbe0c005"><span class="section-number-3">2.1.</span> JUnit</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org5bb0d3a" class="outline-4">
<h4 id="org5bb0d3a"><span class="section-number-4">2.1.1.</span> JUnit 简介</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
JUint是Java编程语言的单元测试框架，用于编写和运行可重复的自动化测试。
<br />
</p>
<ul class="org-ul">
<li>官网地址：<a href="https://junit.org/junit4/">https://junit.org/junit4/</a></li>
<li>官方入门文档：<a href="https://github.com/junit-team/junit4/wiki/Assertions">https://github.com/junit-team/junit4/wiki/Assertions</a></li>
<li>官方github：<a href="https://github.com/junit-team">https://github.com/junit-team</a></li>
</ul>
<p>
<br />
<b><b>JUnit 特点</b></b>
</p>
<ul class="org-ul">
<li>提供注解来识别测试方法。</li>
<li>提供断言来测试预期结果。</li>
<li>JUnit 测试允许你编写代码更快，并能提高质量。</li>
<li>JUnit 优雅简洁。没那么复杂，花费时间较少。</li>
<li>JUnit 测试可以自动运行并且检查自身结果并提供即时反馈。所以也没有必要人工梳理测试结果的报告。</li>
<li>JUnit 测试可以被组织为测试套件，包含测试用例，甚至其他的测试套件。</li>
<li>JUnit 在一个条中显示进度。如果运行良好则是绿色；如果运行失败，则变成红色。</li>
</ul>
</div>
</div>
<div id="outline-container-org0956df2" class="outline-4">
<h4 id="org0956df2"><span class="section-number-4">2.1.2.</span> 常用注解（JUnit 4.x，【】表示JUnit5）</h4>
<div class="outline-text-4" id="text-2-1-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">注解</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">@Test</td>
<td class="org-left">标注测试方法。注意：测试方法必须是public void，即公共、无返回数据。可以抛出异常。</td>
</tr>

<tr>
<td class="org-left">@Ignore【@Disabled】</td>
<td class="org-left">有时候我们想暂时不运行某些测试方法\测试类，可以在方法前加上这个注解。在运行结果中，junit会统计忽略的用例数，来提醒你。但是不建议经常这么做，因为这样的坏处时，容易忘记去更新这些测试方法，导致代码不够干净，用例遗漏。使用此标注的时候不能与其它标注一起使用。</td>
</tr>

<tr>
<td class="org-left">@BeforeClass【@BeforeAll】</td>
<td class="org-left">当我们运行几个有关联的用例时，可能会在数据准备或其它前期准备中执行一些相同的命令，这个时候为了让代码更清晰，更少冗余，可以将公用的部分提取出来，放在一个方法里，并为这个方法注解@BeforeClass。意思是在测试类里所有用例运行之前，运行一次这个方法。例如创建数据库连接、读取文件等。注意：方法名可以任意，但必须是public static void，即公开、静态、无返回。这个方法只会运行一次</td>
</tr>

<tr>
<td class="org-left">@AfterClass【@AfterAll】</td>
<td class="org-left">跟@BeforeClass对应，在测试类里所有用例运行之后，运行一次。用于处理一些测试后续工作，例如清理数据，恢复现场。</td>
</tr>

<tr>
<td class="org-left">@Before【@BeforeEach】</td>
<td class="org-left">与@BeforeClass的区别在于，@Before不止运行一次，它会在每个用例运行之前都运行一次。主要用于一些独立于用例之间的准备工作。注意：必须是public void，不能为static。不止运行一次，根据用例数而定。</td>
</tr>

<tr>
<td class="org-left">@After【@AfterEach】</td>
<td class="org-left">与@Before对应。</td>
</tr>

<tr>
<td class="org-left">@Runwith【@ExtendWith】</td>
<td class="org-left">放在测试类名之前，用来确定这个类怎么运行的。</td>
</tr>

<tr>
<td class="org-left">@Parameters</td>
<td class="org-left">用于使用参数化功能</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org4590205" class="outline-4">
<h4 id="org4590205"><span class="section-number-4">2.1.3.</span> 常用的断言（JUnit 5.x）</h4>
<div class="outline-text-4" id="text-2-1-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">释义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fail</td>
<td class="org-left">断言测试失败</td>
</tr>

<tr>
<td class="org-left">assertTrue/assertFalse</td>
<td class="org-left">断言条件为真或为假</td>
</tr>

<tr>
<td class="org-left">assertEquals/assertNotFalse</td>
<td class="org-left">断言指定两个值相等或不相等, 对于基本数据类型，使用值比较；对于对象，使用equals方法比较。</td>
</tr>

<tr>
<td class="org-left">orgassertArrayEquals</td>
<td class="org-left">断言数组元素全部相等</td>
</tr>

<tr>
<td class="org-left">assertSame/assertNotSame</td>
<td class="org-left">断言指定两个对象是否为同一个对象</td>
</tr>

<tr>
<td class="org-left">assertThrows/assertDoesNotThrow</td>
<td class="org-left">断言是否抛出了一个特定类型的异常</td>
</tr>

<tr>
<td class="org-left">assertlimeout/assertTimeoutPreemptively</td>
<td class="org-left">断言是否执行超时，区别在于测试程序是否在同一个线程内</td>
</tr>

<tr>
<td class="org-left">assertlterableEquals</td>
<td class="org-left">断言迭代器中的元素全部相等</td>
</tr>

<tr>
<td class="org-left">assertLinesMatch</td>
<td class="org-left">断言字符串列表元素全部正则匹配</td>
</tr>

<tr>
<td class="org-left">assertAll</td>
<td class="org-left">断言多个条件同时满足</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org32df989" class="outline-4">
<h4 id="org32df989"><span class="section-number-4">2.1.4.</span> JUnit 使用</h4>
<div class="outline-text-4" id="text-2-1-4">
</div>
<div id="outline-container-org281bd95" class="outline-5">
<h5 id="org281bd95"><span class="section-number-5">2.1.4.1.</span> maven 包依赖引入</h5>
<div class="outline-text-5" id="text-2-1-4-1">
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #8B8878;">&lt;!-- </span><span style="color: #8B8878;">JUnit 4</span><span style="color: #8B8878;"> --&gt;</span>
&lt;<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">groupId</span>&gt;junit&lt;/<span style="color: #87D700;">groupId</span>&gt;
  &lt;<span style="color: #87D700;">artifactId</span>&gt;junit&lt;/<span style="color: #87D700;">artifactId</span>&gt;
  &lt;<span style="color: #87D700;">version</span>&gt;4.13.2&lt;/<span style="color: #87D700;">version</span>&gt;
  &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
&lt;/<span style="color: #87D700;">dependency</span>&gt;
</pre>
</div>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #8B8878;">&lt;!-- </span><span style="color: #8B8878;">JUnit 5</span><span style="color: #8B8878;"> --&gt;</span>
&lt;<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">groupId</span>&gt;org.junit.jupiter&lt;/<span style="color: #87D700;">groupId</span>&gt;
  &lt;<span style="color: #87D700;">artifactId</span>&gt;junit-jupiter-api&lt;/<span style="color: #87D700;">artifactId</span>&gt;
  &lt;<span style="color: #87D700;">version</span>&gt;5.8.2&lt;/<span style="color: #87D700;">version</span>&gt;
  &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
&lt;/<span style="color: #87D700;">dependency</span>&gt;
</pre>
</div>

<p>
<b><b>注意：</b></b> JUnit 4.x 是junit；JUnit 5.x 是junit-jupiter-api
</p>
</div>
</div>
<div id="outline-container-orgeee6be1" class="outline-5">
<h5 id="orgeee6be1"><span class="section-number-5">2.1.4.2.</span> 简单示例(JUnit 4)</h5>
<div class="outline-text-5" id="text-2-1-4-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">Factorial</span> {
    <span style="color: #FF1493;">public</span> <span style="color: #FF1493;">static</span> <span style="color: #5FD7FF;">long</span> <span style="color: #87D700;">fact</span>(<span style="color: #5FD7FF;">long</span> <span style="color: #FF8C00;">n</span>) {
        <span style="color: #5FD7FF;">long</span> <span style="color: #FF8C00;">r</span> = 1;
        <span style="color: #FF1493;">for</span> (<span style="color: #5FD7FF;">long</span> <span style="color: #FF8C00;">i</span> = 1; i &lt;= n; i++) {
            r = r * i;
        }
        <span style="color: #FF1493;">return</span> r;
    }
}
</pre>
</div>

<p>
以 Factorial.java 文件为例，对其进行测试：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;

<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">FactorialTest</span> {
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testFact</span>() {
        Assert.assertEquals(1, Factorial.fact(1));
        Assert.assertEquals(2, Factorial.fact(2));
        Assert.assertEquals(6, Factorial.fact(3));
        Assert.assertEquals(3628800, Factorial.fact(10));
        Assert.assertEquals(2432902008176640000L, Factorial.fact(20));
    }
}
</pre>
</div>

<p>
其他测试还有：
</p>
<ul class="org-ul">
<li>测试：生命周期</li>
<li>测试：禁用测试</li>
<li>测试：断言测试</li>
<li>测试：异常测试</li>
<li>测试：时间测试</li>
<li>测试：参数化测试</li>
<li>测试：套件测试</li>
<li>测试：测试顺序</li>
</ul>
<p>
<br />
更多 JUnit 4 代码示例：<a href="https://www.pdai.tech/md/develop/ut/dev-ut-x-junit.html">https://www.pdai.tech/md/develop/ut/dev-ut-x-junit.html</a>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbb672d7" class="outline-3">
<h3 id="orgbb672d7"><span class="section-number-3">2.2.</span> Mockito</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgce385fd" class="outline-4">
<h4 id="orgce385fd"><span class="section-number-4">2.2.1.</span> Mockito 简介</h4>
<div class="outline-text-4" id="text-2-2-1">
<ol class="org-ol">
<li>Mockito 是最流行的Java mock框架之一;</li>
<li>PowerMockito 是一个用于 Java 单元测试的框架，它扩展了Mockitod的能力。举个例子，你在使用 JUnit 进行单元测试时，并不想让测试数据进入数据库，怎么办？这个时候就可以使用PowerMock，拦截数据库操作，并模拟返回参数</li>
<li>PowerMockito 与 Mockito 的关系
<ul class="org-ul">
<li>PowerMockito 是 Mockito 和 PowerMock 的结合体，旨在扩展 Mockito 的功能，使其能够模拟静态方法、final类、私有方法等无法被常规Mockito框架所模拟的场景。</li>
<li>PowerMockito 通过修改字节码来实现对这些场景的模拟，从而使得在单元测试中能够覆盖更多的情况。</li>
<li>使用 PowerMockito 时，通常需要额外添加相关的依赖，并结合JUnit一起使用。它提供了一些特定的注解和方法，用于标记被测试的类和方法，并进行模拟和验证。</li>
</ul></li>
<li>Mockito 官方网站: <a href="https://site.mockito.org/">https://site.mockito.org/</a></li>
<li>PowerMockito Github: <a href="https://github.com/powermock/powermock/">https://github.com/powermock/powermock/</a></li>
</ol>
</div>
<div id="outline-container-org26eaa57" class="outline-5">
<h5 id="org26eaa57"><span class="section-number-5">2.2.1.1.</span> 节外生枝：什么是 Mock 测试</h5>
<div class="outline-text-5" id="text-2-2-1-1">
<ul class="org-ul">
<li>Mock通常是指，在测试一个对象A时，我们构造一些假的对象来模拟与A之间的交互，而这些Mock对象的行为是我们事先设定且符合预期。通过这些Mock对象来测试A在正常逻辑，异常逻辑或压力情况下工作是否正常。</li>
<li>Mock 测试就是在测试过程中，对于某些不容易构造（如 HttpServletRequest 必须在Servlet 容器中才能构造出来）或者不容易获取比较复杂的对象（如 JDBC 中的ResultSet 对象），用一个虚拟的对象（Mock 对象）来创建以便测试的测试方法。Mock 最大的功能是帮你把单元测试的耦合分解开，如果你的代码对另一个类或者接口有依赖，它能够帮你模拟这些依赖，并帮你验证所调用的依赖的行为。</li>
<li><b><b>定义总结</b></b> ：mock测试就是在测试过程中，对那些不容易构建的对象用一个虚拟对象来代替测试的方法就叫mock测试。</li>
<li>Mock 适用在什么场景
<ul class="org-ul">
<li>真实对象具有不可确定的行为(产生不可预测的结果，如股票的行情)</li>
<li>真实对象很难被创建(比如具体的web容器)</li>
<li>真实对象的某些行为很难触发(比如网络错误)</li>
<li>真实情况令程序的运行速度很慢</li>
<li>真实对象有用户界面</li>
<li>测试需要询问真实对象它是如何被调用的(比如测试可能需要验证某个回调函数是否被调用了)</li>
<li>真实对象实际上并不存在(当需要和其他开发小组，或者新的硬件系统打交道的时候，这是一个普遍的问题)</li>
<li>一些比较难构造的Object：这类Object通常有很多依赖，在单元测试中构造出这样类通常花费的成本太大。</li>
<li>执行操作的时间较长Object：有一些Object的操作费时，而被测对象依赖于这一个操作的执行结果，例如大文件写操作，数据的更新等等，出于测试的需求，通常将这类操作进行Mock。</li>
<li>异常逻辑：一些异常的逻辑往往在正常测试中是很难触发的，通过Mock可以人为的控制触发异常逻辑。</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga6ae34e" class="outline-4">
<h4 id="orga6ae34e"><span class="section-number-4">2.2.2.</span> Mockito 使用</h4>
<div class="outline-text-4" id="text-2-2-2">

<div id="org3ef3615" class="figure">
<p><img src="{{site.url}}/assets/images/test/mockito.png" alt="mockito.png" />
</p>
</div>
</div>
<div id="outline-container-orge444211" class="outline-5">
<h5 id="orge444211"><span class="section-number-5">2.2.2.1.</span> Maven 包依赖引入</h5>
<div class="outline-text-5" id="text-2-2-2-1">
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #87D700;">properties</span>&gt;
  &lt;<span style="color: #87D700;">mockito-core.version</span>&gt;3.12.4&lt;/<span style="color: #87D700;">mockito-core.version</span>&gt;
&lt;/<span style="color: #87D700;">properties</span>&gt;
&lt;<span style="color: #87D700;">dependencies</span>&gt;
  <span style="color: #8B8878;">&lt;!-- </span><span style="color: #8B8878;">Mockito core</span><span style="color: #8B8878;"> --&gt;</span>
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.mockito&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;mockito-core&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">version</span>&gt;${mockito-core.version}&lt;/<span style="color: #87D700;">version</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
&lt;/<span style="color: #87D700;">dependencies</span>&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-orga1df4ba" class="outline-5">
<h5 id="orga1df4ba"><span class="section-number-5">2.2.2.2.</span> Hello Word</h5>
<div class="outline-text-5" id="text-2-2-2-2">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>待测试类</label><pre class="src src-java"><span style="color: #8B8878;">// </span><span style="color: #8B8878;">DemoService</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">interface</span> <span style="color: #5FD7FF;">DemoService</span> {
    <span style="color: #5FD7FF;">int</span> <span style="color: #87D700;">getDemoStatus</span>();
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">DemoServiceImpl</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">DemoServiceImpl</span> <span style="color: #FF1493;">implements</span> <span style="color: #5FD7FF;">DemoService</span> {

    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">DemoDao</span> <span style="color: #FF8C00;">demoDao</span>;

    <span style="color: #FF1493;">public</span> DemoServiceImpl(DemoDao demoDao) {
        <span style="color: #FF1493;">this</span>.demoDao = demoDao;
    }

    <span style="color: #AF87FF;">@Override</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">int</span> <span style="color: #87D700;">getDemoStatus</span>() {
        <span style="color: #FF1493;">return</span> demoDao.getDemoStatus();
    }
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">DemoDao</span>
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Random</span>;

<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">DemoDao</span> {
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">int</span> <span style="color: #87D700;">getDemoStatus</span>(){
        <span style="color: #FF1493;">return</span> <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Random</span>().nextInt();
    }
}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>测试类</label><pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #5FD7FF;">Mockito</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">tech</span>.<span style="color: #AF87FF;">pdai</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #AF87FF;">dao</span>.<span style="color: #5FD7FF;">DemoDao</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">tech</span>.<span style="color: #AF87FF;">pdai</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #AF87FF;">service</span>.<span style="color: #5FD7FF;">DemoService</span>;

<span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;"> * Hello World Test.</span>
<span style="color: #CDC673;"> */</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">HelloWorldTest</span> {

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">helloWorldTest</span>() {
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">mock DemoDao instance</span>
        <span style="color: #5FD7FF;">DemoDao</span> <span style="color: #FF8C00;">mockDemoDao</span> = Mockito.mock(DemoDao.<span style="color: #FF1493;">class</span>);

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20351;&#29992; mockito &#23545; getDemoStatus &#26041;&#27861;&#25171;&#26729;</span>
        Mockito.when(mockDemoDao.getDemoStatus()).thenReturn(1);

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#35843;&#29992; mock &#23545;&#35937;&#30340; getDemoStatus &#26041;&#27861;&#65292;&#32467;&#26524;&#27704;&#36828;&#26159; 1</span>
        Assert.assertEquals(1, mockDemoDao.getDemoStatus());

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">mock DemoService</span>
        <span style="color: #5FD7FF;">DemoService</span> <span style="color: #FF8C00;">mockDemoService</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">DemoService</span>(mockDemoDao);
        Assert.assertEquals(1, mockDemoService.getDemoStatus() );
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org784dd53" class="outline-5">
<h5 id="org784dd53"><span class="section-number-5">2.2.2.3.</span> 一个完整的示例</h5>
<div class="outline-text-5" id="text-2-2-2-3">
</div>
<div id="outline-container-org1ecc55e" class="outline-6">
<h6 id="org1ecc55e"><span class="section-number-6">2.2.2.3.1.</span> 使用 mock 方法</h6>
<div class="outline-text-6" id="text-2-2-2-3-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>包含两块测试：一个是类测试，一个接口测试</label><pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">List</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Random</span>;

<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.Mockito.<span style="color: #5FD7FF;">mock</span>;
<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.Mockito.<span style="color: #5FD7FF;">when</span>;

<span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;"> * Mock Class Test.</span>
<span style="color: #CDC673;"> */</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MockClassTest</span> {

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">mockClassTest</span>() {
        <span style="color: #5FD7FF;">Random</span> <span style="color: #FF8C00;">mockRandom</span> = Mockito.mock(Random.<span style="color: #FF1493;">class</span>);

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#40664;&#35748;&#20540;: mock &#23545;&#35937;&#30340;&#26041;&#27861;&#30340;&#36820;&#22238;&#20540;&#40664;&#35748;&#37117;&#26159;&#36820;&#22238;&#31867;&#22411;&#30340;&#40664;&#35748;&#20540;</span>
        System.out.println(mockRandom.nextBoolean()); <span style="color: #8B8878;">// </span><span style="color: #8B8878;">false</span>
        System.out.println(mockRandom.nextInt()); <span style="color: #8B8878;">// </span><span style="color: #8B8878;">0</span>
        System.out.println(mockRandom.nextDouble()); <span style="color: #8B8878;">// </span><span style="color: #8B8878;">0.0</span>

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">mock: &#25351;&#23450;&#35843;&#29992; nextInt &#26041;&#27861;&#26102;&#65292;&#27704;&#36828;&#36820;&#22238; 100</span>
        Mockito.when(mockRandom.nextInt()).thenReturn(100);
        Assert.assertEquals(100, mockRandom.nextInt());
        Assert.assertEquals(100, mockRandom.nextInt());
    }

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">mockInterfaceTest</span>() {
        <span style="color: #5FD7FF;">List</span> <span style="color: #FF8C00;">mockList</span> = Mockito.mock(List.<span style="color: #FF1493;">class</span>);

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#25509;&#21475;&#30340;&#40664;&#35748;&#20540;&#65306;&#21644;&#31867;&#26041;&#27861;&#19968;&#33268;&#65292;&#37117;&#26159;&#40664;&#35748;&#36820;&#22238;&#20540;</span>
        Assert.assertEquals(0, mockList.size());
        Assert.assertEquals(<span style="color: #AF87FF;">null</span>, mockList.get(0));

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27880;&#24847;&#65306;&#35843;&#29992; mock &#23545;&#35937;&#30340;&#20889;&#26041;&#27861;&#65292;&#26159;&#27809;&#26377;&#25928;&#26524;&#30340;</span>
        mockList.add(<span style="color: #CDC673;">"a"</span>);
        Assert.assertEquals(0, mockList.size());      <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27809;&#26377;&#25351;&#23450; size() &#26041;&#27861;&#36820;&#22238;&#20540;&#65292;&#36825;&#37324;&#32467;&#26524;&#26159;&#40664;&#35748;&#20540;</span>
        Assert.assertEquals(<span style="color: #AF87FF;">null</span>, mockList.get(0));   <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27809;&#26377;&#25351;&#23450; get(0) &#36820;&#22238;&#20540;&#65292;&#36825;&#37324;&#32467;&#26524;&#26159;&#40664;&#35748;&#20540;</span>

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">mock&#20540;&#27979;&#35797;</span>
        Mockito.when(mockList.get(0)).thenReturn(<span style="color: #CDC673;">"a"</span>);          <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#25351;&#23450; get(0)&#26102;&#36820;&#22238; a</span>
        Assert.assertEquals(0, mockList.size());        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27809;&#26377;&#25351;&#23450; size() &#26041;&#27861;&#36820;&#22238;&#20540;&#65292;&#36825;&#37324;&#32467;&#26524;&#26159;&#40664;&#35748;&#20540;</span>
        Assert.assertEquals(<span style="color: #CDC673;">"a"</span>, mockList.get(0));      <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#22240;&#20026;&#19978;&#38754;&#25351;&#23450;&#20102; get(0) &#36820;&#22238; a&#65292;&#25152;&#20197;&#36825;&#37324;&#20250;&#36820;&#22238; a</span>
        Assert.assertEquals(<span style="color: #AF87FF;">null</span>, mockList.get(1));     <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27809;&#26377;&#25351;&#23450; get(1) &#36820;&#22238;&#20540;&#65292;&#36825;&#37324;&#32467;&#26524;&#26159;&#40664;&#35748;&#20540;</span>
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org95f5208" class="outline-6">
<h6 id="org95f5208"><span class="section-number-6">2.2.2.3.2.</span> 使用 @Mock 注解</h6>
<div class="outline-text-6" id="text-2-2-2-3-2">
<pre class="example">
@Mock 注解可以理解为对 mock 方法的一个替代。
</pre>


<p>
使用该注解时，要使用MockitoAnnotations.initMocks 方法，让注解生效, 比如放在@Before方法中初始化。
<br />
比较优雅优雅的写法是用MockitoJUnitRunner，它可以自动执行MockitoAnnotations.initMocks 方法。
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">runner</span>.<span style="color: #5FD7FF;">RunWith</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #5FD7FF;">Mock</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">MockitoJUnitRunner</span>;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Random</span>;

<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.Mockito.<span style="color: #5FD7FF;">when</span>;

<span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;"> * Mock Annotation</span>
<span style="color: #CDC673;"> */</span>
<span style="color: #AF87FF;">@RunWith</span>(MockitoJUnitRunner.<span style="color: #FF1493;">class</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MockAnnotationTest</span> {

    <span style="color: #AF87FF;">@Mock</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">Random</span> <span style="color: #FF8C00;">random</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">test</span>() {
        Mockito.when(random.nextInt()).thenReturn(100);
        Assert.assertEquals(100, random.nextInt());
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org51ddb35" class="outline-6">
<h6 id="org51ddb35"><span class="section-number-6">2.2.2.3.3.</span> 使用参数匹配</h6>
<div class="outline-text-6" id="text-2-2-2-3-3">
<div class="org-src-container">
<pre class="src src-java">Mockito.when(testList.get(anyInt())).thenReturn(<span style="color: #CDC673;">"c"</span>);
Assert.assertEquals(<span style="color: #CDC673;">"c"</span>, testList.get(0));
Assert.assertEquals(<span style="color: #CDC673;">"c"</span>, testList.get(1));
</pre>
</div>

<p>
目前 Mockito 有很多匹配函数，比如any()、anyInt()、anyLong()等等。
</p>
</div>
</div>
<div id="outline-container-orgbdf059a" class="outline-6">
<h6 id="orgbdf059a"><span class="section-number-6">2.2.2.3.4.</span> 使用 mock 异常方法</h6>
<div class="outline-text-6" id="text-2-2-2-3-4">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Random</span>;
<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.Mockito.<span style="color: #5FD7FF;">mock</span>;
<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.Mockito.<span style="color: #5FD7FF;">when</span>;

<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">ThrowTest</span> {
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">throwTest1</span>() {

        <span style="color: #5FD7FF;">Random</span> <span style="color: #FF8C00;">mockRandom</span> = mock(Random.<span style="color: #FF1493;">class</span>);
        when(mockRandom.nextInt()).thenThrow(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">RuntimeException</span>(<span style="color: #CDC673;">"&#24322;&#24120;"</span>));

        <span style="color: #FF1493;">try</span> {
            mockRandom.nextInt();
            Assert.fail();  <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#19978;&#38754;&#20250;&#25243;&#20986;&#24322;&#24120;&#65292;&#25152;&#20197;&#19981;&#20250;&#36208;&#21040;&#36825;&#37324;</span>
        } <span style="color: #FF1493;">catch</span> (Exception ex) {
            Assert.assertTrue(ex <span style="color: #FF1493;">instanceof</span> RuntimeException);
            Assert.assertEquals(<span style="color: #CDC673;">"&#24322;&#24120;"</span>, ex.getMessage());
        }
    }

    <span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;">     * thenThrow &#20013;&#21487;&#20197;&#25351;&#23450;&#22810;&#20010;&#24322;&#24120;&#12290;&#22312;&#35843;&#29992;&#26102;&#24322;&#24120;&#20381;&#27425;&#20986;&#29616;&#12290;&#33509;&#35843;&#29992;&#27425;&#25968;&#36229;&#36807;&#24322;&#24120;&#30340;&#25968;&#37327;&#65292;&#20877;&#27425;&#35843;&#29992;&#26102;&#25243;&#20986;&#26368;&#21518;&#19968;&#20010;&#24322;&#24120;&#12290;</span>
<span style="color: #CDC673;">     */</span>
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">throwTest2</span>() {

        <span style="color: #5FD7FF;">Random</span> <span style="color: #FF8C00;">mockRandom</span> = mock(Random.<span style="color: #FF1493;">class</span>);
        when(mockRandom.nextInt()).thenThrow(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">RuntimeException</span>(<span style="color: #CDC673;">"&#24322;&#24120;1"</span>), <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">RuntimeException</span>(<span style="color: #CDC673;">"&#24322;&#24120;2"</span>));

        <span style="color: #FF1493;">try</span> {
            mockRandom.nextInt();
            Assert.fail();
        } <span style="color: #FF1493;">catch</span> (Exception ex) {
            Assert.assertTrue(ex <span style="color: #FF1493;">instanceof</span> RuntimeException);
            Assert.assertEquals(<span style="color: #CDC673;">"&#24322;&#24120;1"</span>, ex.getMessage());
        }

        <span style="color: #FF1493;">try</span> {
            mockRandom.nextInt();
            Assert.fail();
        } <span style="color: #FF1493;">catch</span> (Exception ex) {
            Assert.assertTrue(ex <span style="color: #FF1493;">instanceof</span> RuntimeException);
            Assert.assertEquals(<span style="color: #CDC673;">"&#24322;&#24120;2"</span>, ex.getMessage());
        }
    }
}
</pre>
</div>

<p>
对应返回类型是 void 的函数，thenThrow 是无效的，要使用 doThrow。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">runner</span>.<span style="color: #5FD7FF;">RunWith</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #5FD7FF;">Mock</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #5FD7FF;">MockitoAnnotations</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">MockitoJUnitRunner</span>;

<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.Mockito.<span style="color: #5FD7FF;">doThrow</span>;

<span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;"> * Do Throw for void return.</span>
<span style="color: #CDC673;"> */</span>
<span style="color: #AF87FF;">@RunWith</span>(MockitoJUnitRunner.<span style="color: #FF1493;">class</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">DoThrowTest</span> {

    <span style="color: #FF1493;">static</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">ExampleService</span> {

        <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">hello</span>() {
            System.out.println(<span style="color: #CDC673;">"Hello"</span>);
        }

    }

    <span style="color: #AF87FF;">@Mock</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">ExampleService</span> <span style="color: #FF8C00;">exampleService</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">test</span>() {

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#36825;&#31181;&#20889;&#27861;&#21487;&#20197;&#36798;&#21040;&#25928;&#26524;</span>
        doThrow(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">RuntimeException</span>(<span style="color: #CDC673;">"&#24322;&#24120;"</span>)).when(exampleService).hello();

        <span style="color: #FF1493;">try</span> {
            exampleService.hello();
            Assert.fail();
        } <span style="color: #FF1493;">catch</span> (RuntimeException ex) {
            Assert.assertEquals(<span style="color: #CDC673;">"&#24322;&#24120;"</span>, ex.getMessage());
        }

    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org8d7eb52" class="outline-6">
<h6 id="org8d7eb52"><span class="section-number-6">2.2.2.3.5.</span> 使用 spy 和 @Spy 注解</h6>
<div class="outline-text-6" id="text-2-2-2-3-5">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #FF1493;">static</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #AF87FF;">Mockito</span>.*;

<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">ExampleService</span> {
    <span style="color: #5FD7FF;">int</span> <span style="color: #87D700;">add</span>(<span style="color: #5FD7FF;">int</span> <span style="color: #FF8C00;">a</span>, <span style="color: #5FD7FF;">int</span> <span style="color: #FF8C00;">b</span>) {
        <span style="color: #FF1493;">return</span> a+b;
    }
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">MockitoDemo</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MockitoDemo</span> {
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27979;&#35797; spy</span>
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">test_spy</span>() {

        <span style="color: #5FD7FF;">ExampleService</span> <span style="color: #FF8C00;">spyExampleService</span> = Mockito.spy(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">ExampleService</span>());

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#40664;&#35748;&#20250;&#36208;&#30495;&#23454;&#26041;&#27861;</span>
        Assert.assertEquals(3, spyExampleService.add(1, 2));

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#25171;&#26729;&#21518;&#65292;&#19981;&#20250;&#36208;&#20102;</span>
        Mockito.when(spyExampleService.add(1, 2)).thenReturn(10);
        Assert.assertEquals(10, spyExampleService.add(1, 2));

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20294;&#26159;&#21442;&#25968;&#27604;&#21305;&#37197;&#30340;&#35843;&#29992;&#65292;&#20381;&#28982;&#36208;&#30495;&#23454;&#26041;&#27861;</span>
        Assert.assertEquals(3, spyExampleService.add(2, 1));

    }

    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27979;&#35797; mock</span>
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">test_mock</span>() {

        <span style="color: #5FD7FF;">ExampleService</span> <span style="color: #FF8C00;">mockExampleService</span> = Mockito.mock(ExampleService.<span style="color: #FF1493;">class</span>);

        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#40664;&#35748;&#36820;&#22238;&#32467;&#26524;&#26159;&#36820;&#22238;&#31867;&#22411;int&#30340;&#40664;&#35748;&#20540;</span>
        Assert.assertEquals(0, mockExampleService.add(1, 2));
    }
}

</pre>
</div>

<p>
对于@Spy，如果发现修饰的变量是 null，会自动调用类的无参构造函数来初始化。所以下面两种写法是等价的：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20889;&#27861;1</span>
<span style="color: #AF87FF;">@Spy</span>
<span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">ExampleService</span> <span style="color: #FF8C00;">spyExampleService</span>;

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20889;&#27861;2</span>
<span style="color: #AF87FF;">@Spy</span>
<span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">ExampleService</span> <span style="color: #FF8C00;">spyExampleService</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">ExampleService</span>();
</pre>
</div>
<p>
如果没有无参构造函数，必须使用写法2。
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org024a455" class="outline-4">
<h4 id="org024a455"><span class="section-number-4">2.2.3.</span> 结合 PowerMock 使用</h4>
<div class="outline-text-4" id="text-2-2-3">
</div>
<div id="outline-container-orgcf37695" class="outline-5">
<h5 id="orgcf37695"><span class="section-number-5">2.2.3.1.</span> maven 包依赖引入</h5>
<div class="outline-text-5" id="text-2-2-3-1">
<p>
<b><b>JUnit 4.4 or above:</b></b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Add the following to your pom.xml if you're using JUnit 4.4 or above:</label><pre class="src src-xml">&lt;<span style="color: #87D700;">properties</span>&gt;
  &lt;<span style="color: #87D700;">powermock.version</span>&gt;2.0.2&lt;/<span style="color: #87D700;">powermock.version</span>&gt;
&lt;/<span style="color: #87D700;">properties</span>&gt;
&lt;<span style="color: #87D700;">dependencies</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.powermock&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;powermock-module-junit4&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">version</span>&gt;${powermock.version}&lt;/<span style="color: #87D700;">version</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.powermock&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;powermock-api-mockito2&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">version</span>&gt;${powermock.version}&lt;/<span style="color: #87D700;">version</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
&lt;/<span style="color: #87D700;">dependencies</span>&gt;
</pre>
</div>

<p>
更多 Maven 配置点击链接查看：<a href="https://github.com/powermock/powermock/wiki/Mockito#maven-configuration">https://github.com/powermock/powermock/wiki/Mockito#maven-configuration</a>
</p>
</div>
</div>
<div id="outline-container-org991ff2e" class="outline-5">
<h5 id="org991ff2e"><span class="section-number-5">2.2.3.2.</span> 关键注解说明</h5>
<div class="outline-text-5" id="text-2-2-3-2">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>关键注解</label><pre class="src src-java"><span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#21578;&#35785;JUnit&#20351;&#29992;PowerMockRunner&#36827;&#34892;&#27979;&#35797;</span>
<span style="color: #AF87FF;">@RunWith</span>(PowerMockRunner.<span style="color: #FF1493;">class</span>)
<span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#25152;&#26377;&#38656;&#35201;&#27979;&#35797;&#30340;&#31867;&#21015;&#22312;&#27492;&#22788;&#65292;&#36866;&#29992;&#20110;&#27169;&#25311;final&#31867;&#25110;&#26377;final, private, static, native&#26041;&#27861;&#30340;&#31867;</span>
<span style="color: #AF87FF;">@PrepareForTest</span>({RandomUtil.<span style="color: #FF1493;">class</span>})
<span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20026;&#20102;&#35299;&#20915;&#20351;&#29992;powermock&#21518;&#65292;&#25552;&#31034;classloader&#38169;&#35823;</span>
<span style="color: #AF87FF;">@PowerMockIgnore</span>(<span style="color: #CDC673;">"javax.management.*"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MockitoDemo</span> {
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">test</span>() {
        PowerMockito.mockStatic(RandomUtil.<span style="color: #FF1493;">class</span>);

        PowerMockito.when(RandomUtil.nextInt(Mockito.any())).thenReturn(100);

        Assert.assertEquals(100, RandomUtil.nextInt(2));
    }
}
</pre>
</div>
</div>

<div id="outline-container-org27104c3" class="outline-6">
<h6 id="org27104c3"><span class="section-number-6">2.2.3.2.1.</span> @Mock 和 @MockBean</h6>
<div class="outline-text-6" id="text-2-2-3-2-1">
<p>
`@Mock` 和 `@MockBean` 是用于模拟对象的注解，但它们之间有一些区别：
</p>
<ol class="org-ol">
<li>@Mock：
<ul class="org-ul">
<li>用于模拟不属于 Spring 上下文的对象。</li>
<li>在普通的 JUnit 测试中使用。</li>
<li>不知道 Spring 上下文，通常用于单元测试隔离组件，而不需要完整的 Spring 上下文设置。</li>
<li>可以通过 Mockito 框架创建一个空的类，其中方法体都是空的，方法的返回值（如果有的话）都是 `null`。</li>
<li>使代码更易读，且在出现失败时，可以更容易地找到问题所在的模拟对象。</li>
</ul></li>
<li><p>
@MockBean：
</p>
<ul class="org-ul">
<li>用于模拟属于 Spring 上下文的一部分的对象。</li>
<li>在集成测试中很有用，当需要模拟特定的 Spring bean 时，例如外部的 Service。</li>
<li>将 Mock 对象添加到 Spring 应用程序上下文中，它会替换掉相同类型的现有 bean，如果没有定义相同类型的 bean，它将添加一个新的 bean。</li>
</ul>
<p>
总之，`@Mock` 适用于普通的 JUnit 测试，而 `@MockBean` 适用于集成测试，需要模拟 Spring 上下文中的特定 bean。
</p></li>
</ol>
</div>
</div>
<div id="outline-container-org3d0d3ed" class="outline-6">
<h6 id="org3d0d3ed"><span class="section-number-6">2.2.3.2.2.</span> @Mock 和 @InjectMocks</h6>
<div class="outline-text-6" id="text-2-2-3-2-2">
<ol class="org-ol">
<li>@InjectMocks
<ul class="org-ul">
<li>@InjectMocks 注解用于标记被测试类的实例，在测试中会自动创建该类的实例，并注入被@Mock注解标记的模拟对象。</li>
<li>当测试类中的某个方法需要被测试时，使用@InjectMocks注解标记被测试的类实例，Mockito会自动将被标记为@Mock的模拟对象注入到被测试类的实例中。</li>
<li>通常情况下，@InjectMocks用于测试目标类，即待测试的类，它会自动将依赖的模拟对象注入到目标类中。</li>
</ul></li>
<li>@Mock
<ul class="org-ul">
<li>@Mock注解用于标记需要模拟的对象，即需要在测试中替代的对象。通过@Mock注解，我们可以模拟外部依赖或者需要被测试类调用的其他对象。</li>
<li>使用@Mock注解标记的对象会被Mockito框架创建为模拟对象，并在测试中被用于替代实际对象的行为。</li>
<li>通常情况下，@Mock用于模拟测试类所依赖的其他类或者对象，以隔离测试对象与其依赖对象的关系。</li>
<li><p>
使用@Mock后，记得initMocks。
</p>
<div class="org-src-container">
<pre class="src src-java">MockitoAnnotations.initMocks(<span style="color: #FF1493;">this</span>);
</pre>
</div></li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org056c616" class="outline-6">
<h6 id="org056c616"><span class="section-number-6">2.2.3.2.3.</span> Mockito 和 PowerMockito</h6>
<div class="outline-text-6" id="text-2-2-3-2-3">
<ul class="org-ul">
<li><b><b>Mockito</b></b>
<ol class="org-ol">
<li>核心功能：
<ul class="org-ul">
<li>Mockito 主要用于模拟对象（实例方法）的行为，允许创建和配置模拟对象来替代真实对象，以便在测试中控制其输出和行为。</li>
<li>它可以模拟非final类、非final方法、非static方法，以及具有可见性（public、protected、default）的方法。</li>
</ul></li>
<li>模拟方式：
<ul class="org-ul">
<li>使用Mockito.mock(Class&lt;T&gt;)方法创建模拟对象。</li>
<li>通过when(&#x2026;).thenReturn(&#x2026;), doReturn(&#x2026;).when(&#x2026;)等方法设置模拟对象的方法调用返回值或行为。</li>
</ul></li>
<li>限制：
<ul class="org-ul">
<li>Mockito 本身不能直接模拟静态方法、构造函数、final类或方法、私有方法，以及静态初始化块。</li>
<li>对于依赖注入困难或设计不佳导致难以模拟的情况，可能需要重构代码以适应 Mockito。</li>
</ul></li>
</ol></li>
<li><b><b>PowerMockito</b></b>
<ol class="org-ol">
<li>扩展功能：
<ul class="org-ul">
<li>PowerMockito 是基于 Mockito 构建的扩展库，它主要解决了 Mockito 不能模拟的一些特性，包括：</li>
<li>静态方法：可以模拟类的静态方法，无论它们是否为final或私有。</li>
<li>构造函数：可以模拟构造函数的行为，如返回特定的模拟对象或抑制构造函数的副作用。</li>
<li>final类与方法：可以模拟final类及其方法的行为。</li>
<li>私有方法：可以模拟私有方法，使得它们在测试中可以被替换或控制其返回值。</li>
<li>静态初始化块：可以抑制类的静态初始化块的执行。</li>
</ul></li>
<li>模拟方式：
<ul class="org-ul">
<li>使用PowerMockito.mockStatic(Class&lt;T&gt;)模拟静态方法。</li>
<li>使用PowerMockito.whenNew(Constructor&lt;T&gt;)模拟构造函数。</li>
<li>对于final类、方法或私有方法，仍然使用类似于 Mockito 的when(&#x2026;).thenReturn(&#x2026;)等方式设置模拟行为。</li>
<li>有时需要配合@RunWith(PowerMockRunner.class)和@PrepareForTest(Class&lt;T&gt;)注解来启用PowerMockito的高级特性。</li>
</ul></li>
<li>使用场景：
<ul class="org-ul">
<li>适用于测试遗留代码、第三方库、框架代码或其他难以修改以适应标准单元测试的代码。</li>
<li>当需要模拟上述Mockito无法处理的特性时，PowerMockito提供了强大的解决方案。</li>
</ul></li>
</ol></li>
</ul>
<p>
<br />
<b><b>总结：</b></b>
</p>
<ol class="org-ol">
<li>Mockito 是一个轻量级、易于使用的模拟库，适用于大多数常规的单元测试场景，特别是在遵循良好设计原则（如依赖注入、接口隔离等）编写的代码中。</li>
<li>PowerMockito 则提供了更强大的模拟能力，能够处理更复杂的场景，如模拟静态方法、构造函数、final类/方法、私有方法等。然而，由于其使用了类加载器替换和字节码操纵技术，可能会引入额外的复杂性和潜在风险，且对测试代码结构有一定要求（如使用特定的测试运行器和注解）。因此，PowerMockito通常是在必要时作为最后手段使用，特别是在面对难以修改或外部约束较多的遗留代码时。</li>
<li>选择使用哪一个库取决于项目的具体需求、代码结构以及对测试侵入性的接受程度。通常建议优先考虑使用 Mockito，只有在遇到其无法解决的模拟问题时才考虑使用 PowerMockito。同时，应尽量避免过度依赖PowerMockito，因为它可能掩盖代码设计上的问题，长期来看不利于代码的维护和演进。</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgad2fc1e" class="outline-5">
<h5 id="orgad2fc1e"><span class="section-number-5">2.2.3.3.</span> 常见问题</h5>
<div class="outline-text-5" id="text-2-2-3-3">
</div>
<div id="outline-container-org443bf53" class="outline-6">
<h6 id="org443bf53"><span class="section-number-6">2.2.3.3.1.</span> java.lang.NoClassDefFoundError: Could not initialize class org.mockito.Mockito</h6>
<div class="outline-text-6" id="text-2-2-3-3-1">
<ul class="org-ul">
<li>原因：`mockito-core`版本不兼容</li>
<li><p>
解决：指定mockito-core依赖版本，这里用`3.12.4`
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #87D700;">mockito-core.version</span>&gt;3.12.4&lt;/<span style="color: #87D700;">mockito-core.version</span>&gt;

&lt;<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">groupId</span>&gt;org.mockito&lt;/<span style="color: #87D700;">groupId</span>&gt;
  &lt;<span style="color: #87D700;">artifactId</span>&gt;mockito-core&lt;/<span style="color: #87D700;">artifactId</span>&gt;
  &lt;<span style="color: #87D700;">version</span>&gt;${mockito-core.version}&lt;/<span style="color: #87D700;">version</span>&gt;
  &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
&lt;/<span style="color: #87D700;">dependency</span>&gt;
</pre>
</div></li>
<li>参考：<a href="https://github.com/mockito/mockito/issues/2568">https://github.com/mockito/mockito/issues/2568</a></li>
</ul>
</div>
</div>
<div id="outline-container-org1fc2ecd" class="outline-6">
<h6 id="org1fc2ecd"><span class="section-number-6">2.2.3.3.2.</span> ScriptEngineManager providers.next(): javax.script.ScriptEngineFactory: Provider jdk.nashorn.api.scripting.NashornScriptEngineFactory not a subtype</h6>
<div class="outline-text-6" id="text-2-2-3-3-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@PowerMockIgnore</span>({<span style="color: #CDC673;">"javax.script.*"</span>})
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf73289b" class="outline-6">
<h6 id="orgf73289b"><span class="section-number-6">2.2.3.3.3.</span> Could not reconfigure JMX java.lang.LinkageError</h6>
<div class="outline-text-6" id="text-2-2-3-3-3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@PowerMockIgnore</span>({<span style="color: #CDC673;">"javax.management.*"</span>})
</pre>
</div>
</div>
</div>
<div id="outline-container-org21d58d7" class="outline-6">
<h6 id="org21d58d7"><span class="section-number-6">2.2.3.3.4.</span> 解决用 @Value 注解注入的属性</h6>
<div class="outline-text-6" id="text-2-2-3-3-4">
<div class="org-src-container">
<pre class="src src-java">ReflectionTestUtils.setField(<span style="color: #5FD7FF;">invoiceTitleService</span>, <span style="color: #CDC673;">"invoiceTitleRegularExpression"</span>, <span style="color: #CDC673;">"^[a-zA-Z0-9\\u4e00-\\u9fa5\\s\\uFF08\\uFF09\\u3001\\(\\)\\&lt;\\&gt;\\u300a\\u300b\\(\\)\\-]+$"</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-org9780d56" class="outline-6">
<h6 id="org9780d56"><span class="section-number-6">2.2.3.3.5.</span> 解决通过 environment.getProperty("property") 获取配置文件中的配置项值</h6>
<div class="outline-text-6" id="text-2-2-3-3-5">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@Mock</span>
<span style="color: #5FD7FF;">Environment</span> <span style="color: #FF8C00;">environment</span>;

<span style="color: #AF87FF;">@BeforeMethod</span>(alwaysRun = <span style="color: #AF87FF;">true</span>)
<span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">init</span> () {
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#21021;&#22987;&#21270;&#24403;&#21069;&#27979;&#35797;&#31867;&#25152;&#26377;Mock&#27880;&#35299;&#27169;&#25311;&#23545;&#35937;</span>
    MockitoAnnotations.initMocks(<span style="color: #FF1493;">this</span>);
}

<span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testXXX</span>() {
    when(environment.getProperty(<span style="color: #CDC673;">"config.name"</span>)).thenReturn(<span style="color: #CDC673;">"tom"</span>);
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org6ffb7fb" class="outline-6">
<h6 id="org6ffb7fb"><span class="section-number-6">2.2.3.3.6.</span> 使用RestTemplate调用controller方法时，404错误</h6>
<div class="outline-text-6" id="text-2-2-3-3-6">
<ul class="org-ul">
<li>检查controller类使用@RestController注解</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org1d2c756" class="outline-2">
<h2 id="org1d2c756"><span class="section-number-2">3.</span> 单元测试的最佳实践</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org0511866" class="outline-3">
<h3 id="org0511866"><span class="section-number-3">3.1.</span> 对 Controller 层的测试实践</h3>
<div class="outline-text-3" id="text-3-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">模块</th>
<th scope="col" class="org-right">版本号</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Spring boot test</td>
<td class="org-right">2.7.6</td>
<td class="org-left">支持测试的核心内容</td>
</tr>

<tr>
<td class="org-left">Spring boot test autoconfigure</td>
<td class="org-right">2.7.6</td>
<td class="org-left">支持测试的自动化配置</td>
</tr>

<tr>
<td class="org-left">JUnit5</td>
<td class="org-right">5.8.2</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org9a3c90a" class="outline-4">
<h4 id="org9a3c90a"><span class="section-number-4">3.1.1.</span> maven 包依赖引入</h4>
<div class="outline-text-4" id="text-3-1-1">
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #87D700;">dependencies</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;spring-boot-starter&lt;/<span style="color: #87D700;">artifactId</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;

  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;spring-boot-starter-test&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
&lt;/<span style="color: #87D700;">dependencies</span>&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org1a2cb62" class="outline-4">
<h4 id="org1a2cb62"><span class="section-number-4">3.1.2.</span> Springboot + JUnit</h4>
<div class="outline-text-4" id="text-3-1-2">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Springboot + junit4</label><pre class="src src-java"><span style="color: #AF87FF;">@RunWith</span>(SpringRunner.<span style="color: #FF1493;">class</span>)
<span style="color: #AF87FF;">@SpringBootTest</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">SpringBootQuickStartApplicationTests</span> {

    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">MockMvc</span> <span style="color: #FF8C00;">mvc</span>;

    <span style="color: #AF87FF;">@Before</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">setUp</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        mvc = MockMvcBuilders.standaloneSetup(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">UserController</span>()).build();
    }

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">contextLoads</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">RequestBuilder</span> <span style="color: #FF8C00;">request</span> = <span style="color: #AF87FF;">null</span>;

        request = MockMvcRequestBuilders.get(<span style="color: #CDC673;">"/"</span>)
                .contentType(<span style="color: #AF87FF;">MediaType</span>.APPLICATION_JSON);
        mvc.perform(request)
                .andExpect(MockMvcResultMatchers.status().isOk())
                .andDo(MockMvcResultHandlers.print())
                .andReturn();
   }
}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>Springboot + junit5</label><pre class="src src-java"><span style="color: #AF87FF;">@SpringBootTest</span>
<span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20351;&#29992;spring&#30340;&#27979;&#35797;&#26694;&#26550;</span>
<span style="color: #AF87FF;">@ExtendWith</span>(SpringExtension.<span style="color: #FF1493;">class</span>)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">SpringbootQuickStartApplicationTests</span> {

    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">MockMvc</span> <span style="color: #FF8C00;">mockMvc</span>;

    <span style="color: #AF87FF;">@BeforeEach</span> <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#31867;&#20284;&#20110;junit4&#30340;@Before</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">setUp</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        mockMvc = MockMvcBuilders.standaloneSetup(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">UserController</span>()).build();
    }

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">contextLoads</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">RequestBuilder</span> <span style="color: #FF8C00;">request</span> = <span style="color: #AF87FF;">null</span>;

        request = MockMvcRequestBuilders.get(<span style="color: #CDC673;">"/"</span>)
                .contentType(<span style="color: #AF87FF;">MediaType</span>.APPLICATION_JSON);
        mockMvc.perform(request)
                .andExpect(MockMvcResultMatchers.status().isOk())
                .andDo(MockMvcResultHandlers.print())
                .andReturn();
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org99784a0" class="outline-4">
<h4 id="org99784a0"><span class="section-number-4">3.1.3.</span> 使用随机端口测试</h4>
<div class="outline-text-4" id="text-3-1-3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MpServiceApplicationTests</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">testRestTemplate</span> = <span style="color: #AF87FF;">null</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testApi</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">&#19968;&#20010;&#38190;&#23545;&#24212;&#22810;&#20010;&#20540;, &#22914; put &#26041;&#27861;: put(String, List&lt;String&gt;)</span>
        <span style="color: #5FD7FF;">MultiValueMap</span>&lt;<span style="color: #5FD7FF;">String</span>, <span style="color: #5FD7FF;">String</span>&gt; <span style="color: #FF8C00;">params</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">LinkedMultiValueMap</span>&lt;&gt;();
        params.add(<span style="color: #CDC673;">"orderId"</span>, <span style="color: #CDC673;">"ORDER20210312010000000046"</span>);
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">postForObject &#40664;&#35748;&#21482;&#33021;&#26144;&#23556; Map &#31867;&#22411;&#36820;&#22238;&#65292;&#22914;&#26524;&#26159;&#23454;&#20307;&#31867;&#21017;&#26144;&#23556;&#19981;&#21040;&#23646;&#24615;&#30340;&#20540;&#65292;&#38656;&#35201;&#24378;&#36716;&#25110;&#32773;&#20351;&#29992; postForEntity</span>
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">Map orderMap = testRestTemplate.postForObject("/api/mp/order/info", params, Map.class);</span>
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">if (!ObjectUtils.isEmpty(orderMap)) {</span>
        <span style="color: #8B8878;">//    </span><span style="color: #8B8878;">MpOrder order = (MpOrder) orderMap;</span>
        <span style="color: #8B8878;">//    </span><span style="color: #8B8878;">System.out.println("order = " + order);</span>
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">}</span>
        <span style="color: #5FD7FF;">ResponseEntity</span>&lt;<span style="color: #5FD7FF;">MpOrder</span>&gt; <span style="color: #FF8C00;">mpOrderResponseEntity</span> = testRestTemplate.postForEntity(<span style="color: #CDC673;">"/api/mp/order/info"</span>, params, MpOrder.<span style="color: #FF1493;">class</span>);
        <span style="color: #5FD7FF;">MpOrder</span> <span style="color: #FF8C00;">order</span> = mpOrderResponseEntity.getBody();
        System.out.println(<span style="color: #CDC673;">"order = "</span> + order);
    }
}
</pre>
</div>
</div>
<div id="outline-container-org7efe075" class="outline-5">
<h5 id="org7efe075"><span class="section-number-5">3.1.3.1.</span> TestRestTemplate 使用</h5>
<div class="outline-text-5" id="text-3-1-3-1">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@Slf4j</span>
<span style="color: #AF87FF;">@RunWith</span>(SpringRunner.<span style="color: #FF1493;">class</span>)
<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">AccountControllerTests</span> {
    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">restTemplate</span>;
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">HttpEntity</span> <span style="color: #FF8C00;">httpEntity</span>;

    <span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;">     * &#30331;&#24405;</span>
<span style="color: #CDC673;">     * </span><span style="color: #AF87FF;">@throws</span><span style="color: #CDC673;"> Exception</span>
<span style="color: #CDC673;">     */</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">login</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">expectStr</span> = <span style="color: #CDC673;">"{\"code\":0,\"msg\":\"success\"}"</span>;
        <span style="color: #5FD7FF;">MultiValueMap</span>&lt;<span style="color: #5FD7FF;">String</span>, <span style="color: #5FD7FF;">String</span>&gt; <span style="color: #FF8C00;">map</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">LinkedMultiValueMap</span>&lt;&gt;();
        map.add(<span style="color: #CDC673;">"username"</span>, <span style="color: #CDC673;">"183xxxxxxxx"</span>);
        map.add(<span style="color: #CDC673;">"password"</span>, <span style="color: #CDC673;">"123456"</span>);
        <span style="color: #5FD7FF;">ResponseEntity</span> <span style="color: #FF8C00;">responseEntity</span> = restTemplate.postForEntity(<span style="color: #CDC673;">"/api/account/sign_in"</span>, map, String.<span style="color: #FF1493;">class</span>);
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">&#28155;&#21152;cookie&#20197;&#20445;&#25345;&#29366;&#24577;</span>
        <span style="color: #5FD7FF;">HttpHeaders</span> <span style="color: #FF8C00;">headers</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HttpHeaders</span>();
        <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">headerValue</span> = responseEntity.getHeaders().get(<span style="color: #CDC673;">"Set-Cookie"</span>).toString().replace(<span style="color: #CDC673;">"["</span>, <span style="color: #CDC673;">""</span>);
        headerValue = headerValue.replace(<span style="color: #CDC673;">"]"</span>, <span style="color: #CDC673;">""</span>);
        headers.set(<span style="color: #CDC673;">"Cookie"</span>, headerValue);
        httpEntity = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HttpEntity</span>(headers);
        assertThat(responseEntity.getBody()).isEqualTo(expectStr);
    }

    <span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;">     * &#30331;&#20986;</span>
<span style="color: #CDC673;">     * </span><span style="color: #AF87FF;">@throws</span><span style="color: #CDC673;"> Exception</span>
<span style="color: #CDC673;">     */</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">logout</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">expectStr</span> = <span style="color: #CDC673;">"{\"code\":0,\"msg\":\"success\"}"</span>;
        <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">result</span> = restTemplate.postForObject(<span style="color: #CDC673;">"/api/account/sign_out"</span>, <span style="color: #AF87FF;">null</span>, String.<span style="color: #FF1493;">class</span>, httpEntity);
        httpEntity = <span style="color: #AF87FF;">null</span>;
        assertThat(result).isEqualTo(expectStr);
    }

    <span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;">     * &#33719;&#21462;&#20449;&#24687;</span>
<span style="color: #CDC673;">     * </span><span style="color: #AF87FF;">@throws</span><span style="color: #CDC673;"> Exception</span>
<span style="color: #CDC673;">     */</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">getUserInfo</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">Detail</span> <span style="color: #FF8C00;">detail</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Detail</span>();
        detail.setNickname(<span style="color: #CDC673;">"&#30127;&#29378;&#30340;&#31859;&#32769;&#40736;"</span>);
        detail.setNicknamePinyin(<span style="color: #CDC673;">"fengkuangdemilaoshu"</span>);
        detail.setSex(1);
        <span style="color: #5FD7FF;">SimpleDateFormat</span> <span style="color: #FF8C00;">sdf</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">SimpleDateFormat</span>(<span style="color: #CDC673;">"yyyy-MM-dd HH:mm:ss"</span>);
        detail.setCreatedAt(sdf.parse(<span style="color: #CDC673;">"2017-11-03 16:43:27"</span>));
        detail.setUpdatedAt(sdf.parse(<span style="color: #CDC673;">"2017-11-03 16:43:27"</span>));
        <span style="color: #5FD7FF;">Role</span> <span style="color: #FF8C00;">role</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Role</span>();
        role.setName(<span style="color: #CDC673;">"ROLE_USER_NORMAL"</span>);
        <span style="color: #5FD7FF;">Set</span>&lt;<span style="color: #5FD7FF;">Role</span>&gt; <span style="color: #FF8C00;">roles</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HashSet</span>&lt;&gt;();
        roles.add(role);
        <span style="color: #5FD7FF;">User</span> <span style="color: #FF8C00;">user</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">User</span>();
        user.setId(1L);
        user.setPhone(<span style="color: #CDC673;">"183xxxxxxxx"</span>);
        user.setEmail(<span style="color: #CDC673;">"xxxxxx@gmail.com"</span>);
        user.setDetail(detail);
        user.setRoles(roles);
        <span style="color: #5FD7FF;">ResultBean</span>&lt;<span style="color: #5FD7FF;">User</span>&gt; <span style="color: #FF8C00;">resultBean</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">ResultBean</span>&lt;&gt;();
        resultBean.setData(user);
        <span style="color: #5FD7FF;">ObjectMapper</span> <span style="color: #FF8C00;">om</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">ObjectMapper</span>();
        <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">expectStr</span> = om.writeValueAsString(resultBean);
        <span style="color: #5FD7FF;">ResponseEntity</span>&lt;<span style="color: #5FD7FF;">String</span>&gt; <span style="color: #FF8C00;">responseEntity</span> = restTemplate.exchange(<span style="color: #CDC673;">"/api/user/get_user_info"</span>, <span style="color: #AF87FF;">HttpMethod</span>.GET, httpEntity, String.<span style="color: #FF1493;">class</span>);
        assertThat(responseEntity.getBody()).isEqualTo(expectStr);
    }

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testAccount</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        login();
        getUserInfo();
        logout();
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org0c90412" class="outline-5">
<h5 id="org0c90412"><span class="section-number-5">3.1.3.2.</span> GET 请求测试</h5>
<div class="outline-text-5" id="text-3-1-3-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">jupiter</span>.<span style="color: #AF87FF;">api</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">beans</span>.<span style="color: #AF87FF;">factory</span>.<span style="color: #AF87FF;">annotation</span>.<span style="color: #5FD7FF;">Autowired</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">context</span>.<span style="color: #5FD7FF;">SpringBootTest</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">web</span>.<span style="color: #AF87FF;">client</span>.<span style="color: #5FD7FF;">TestRestTemplate</span>;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">HashMap</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Map</span>;

<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MpServiceApplicationTests</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">testRestTemplate</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">get</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">Map</span>&lt;<span style="color: #5FD7FF;">String</span>, <span style="color: #5FD7FF;">String</span>&gt; <span style="color: #FF8C00;">multiValueMap</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HashMap</span>&lt;&gt;();
        multiValueMap.put(<span style="color: #CDC673;">"username"</span>, <span style="color: #CDC673;">"Jerry"</span>);
        <span style="color: #5FD7FF;">Map</span> <span style="color: #FF8C00;">result</span> = testRestTemplate.getForObject(<span style="color: #CDC673;">"/test/getUser?username={username}"</span>, Map.<span style="color: #FF1493;">class</span>, multiValueMap);
        Assert.assertEquals(result, 0);
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf07001b" class="outline-5">
<h5 id="orgf07001b"><span class="section-number-5">3.1.3.3.</span> POST 请求测试</h5>
<div class="outline-text-5" id="text-3-1-3-3">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">jupiter</span>.<span style="color: #AF87FF;">api</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">beans</span>.<span style="color: #AF87FF;">factory</span>.<span style="color: #AF87FF;">annotation</span>.<span style="color: #5FD7FF;">Autowired</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">context</span>.<span style="color: #5FD7FF;">SpringBootTest</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">web</span>.<span style="color: #AF87FF;">client</span>.<span style="color: #5FD7FF;">TestRestTemplate</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">LinkedMultiValueMap</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">MultiValueMap</span>;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Map</span>;

<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MpServiceApplicationTests</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">testRestTemplate</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">post</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">MultiValueMap</span> <span style="color: #FF8C00;">multiValueMap</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">LinkedMultiValueMap</span>();
        multiValueMap.add(<span style="color: #CDC673;">"username"</span>, <span style="color: #CDC673;">"Jerry"</span>);
        <span style="color: #5FD7FF;">Map</span> <span style="color: #FF8C00;">result</span> = testRestTemplate.postForObject(<span style="color: #CDC673;">"/test/post"</span>, multiValueMap, Map.<span style="color: #FF1493;">class</span>);
        Assert.assertEquals(result, 0);
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcde1cb5" class="outline-5">
<h5 id="orgcde1cb5"><span class="section-number-5">3.1.3.4.</span> 文件上传请求测试</h5>
<div class="outline-text-5" id="text-3-1-3-4">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">jupiter</span>.<span style="color: #AF87FF;">api</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">beans</span>.<span style="color: #AF87FF;">factory</span>.<span style="color: #AF87FF;">annotation</span>.<span style="color: #5FD7FF;">Autowired</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">context</span>.<span style="color: #5FD7FF;">SpringBootTest</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">web</span>.<span style="color: #AF87FF;">client</span>.<span style="color: #5FD7FF;">TestRestTemplate</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">core</span>.<span style="color: #AF87FF;">io</span>.<span style="color: #5FD7FF;">FileSystemResource</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">core</span>.<span style="color: #AF87FF;">io</span>.<span style="color: #5FD7FF;">Resource</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">LinkedMultiValueMap</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">MultiValueMap</span>;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">util</span>.<span style="color: #5FD7FF;">Map</span>;

<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MpServiceApplicationTests</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">testRestTemplate</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">upload</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">Resource</span> <span style="color: #FF8C00;">resource</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">FileSystemResource</span>(<span style="color: #CDC673;">"/home/javastack/test.jar"</span>);
        <span style="color: #5FD7FF;">MultiValueMap</span> <span style="color: #FF8C00;">multiValueMap</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">LinkedMultiValueMap</span>();
        multiValueMap.add(<span style="color: #CDC673;">"username"</span>, <span style="color: #CDC673;">"Jerry"</span>);
        multiValueMap.add(<span style="color: #CDC673;">"files"</span>, resource);
        <span style="color: #5FD7FF;">Map</span> <span style="color: #FF8C00;">result</span> = testRestTemplate.postForObject(<span style="color: #CDC673;">"/test/upload"</span>, multiValueMap, Map.<span style="color: #FF1493;">class</span>);
        Assert.assertEquals(result, 0);
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orge2cf0c4" class="outline-5">
<h5 id="orge2cf0c4"><span class="section-number-5">3.1.3.5.</span> 文件下载请求测试</h5>
<div class="outline-text-5" id="text-3-1-3-5">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">google</span>.<span style="color: #AF87FF;">common</span>.<span style="color: #AF87FF;">io</span>.<span style="color: #5FD7FF;">Files</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">jupiter</span>.<span style="color: #AF87FF;">api</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">beans</span>.<span style="color: #AF87FF;">factory</span>.<span style="color: #AF87FF;">annotation</span>.<span style="color: #5FD7FF;">Autowired</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">context</span>.<span style="color: #5FD7FF;">SpringBootTest</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">web</span>.<span style="color: #AF87FF;">client</span>.<span style="color: #5FD7FF;">TestRestTemplate</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">http</span>.*;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">java</span>.<span style="color: #AF87FF;">io</span>.<span style="color: #5FD7FF;">File</span>;

<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MpServiceApplicationTests</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">testRestTemplate</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">download</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">HttpHeaders</span> <span style="color: #FF8C00;">headers</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HttpHeaders</span>();
        headers.set(<span style="color: #CDC673;">"token"</span>, <span style="color: #CDC673;">"Jerry"</span>);
        <span style="color: #5FD7FF;">HttpEntity</span> <span style="color: #FF8C00;">formEntity</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HttpEntity</span>(headers);
        <span style="color: #5FD7FF;">String</span>[] <span style="color: #FF8C00;">urlVariables</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">String</span>[]{<span style="color: #CDC673;">"admin"</span>};
        <span style="color: #5FD7FF;">ResponseEntity</span>&lt;<span style="color: #5FD7FF;">byte</span>[]&gt; <span style="color: #FF8C00;">response</span> = testRestTemplate.exchange(<span style="color: #CDC673;">"/test/download?username={1}"</span>, <span style="color: #AF87FF;">HttpMethod</span>.GET, formEntity, <span style="color: #5FD7FF;">byte</span>[].<span style="color: #FF1493;">class</span>, urlVariables);
        <span style="color: #FF1493;">if</span> (response.getStatusCode() == <span style="color: #AF87FF;">HttpStatus</span>.OK) {
            Files.write(response.getBody(), <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">File</span>(<span style="color: #CDC673;">"/home/Jerry/test.jar"</span>));
        }
    }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org574ebdc" class="outline-4">
<h4 id="org574ebdc"><span class="section-number-4">3.1.4.</span> 使用Mock测试</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
使用 @MockBean 注解，以及虚拟数据进行测试，不会写入持久化数据库。（注意：这里仅做简单介绍和使用，在下一章节中详细介绍。）
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">jupiter</span>.<span style="color: #AF87FF;">api</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #5FD7FF;">BDDMockito</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">context</span>.<span style="color: #5FD7FF;">SpringBootTest</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">boot</span>.<span style="color: #AF87FF;">test</span>.<span style="color: #AF87FF;">mock</span>.<span style="color: #AF87FF;">mockito</span>.<span style="color: #5FD7FF;">MockBean</span>;

<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MpServiceApplicationTests</span> {

    <span style="color: #AF87FF;">@MockBean</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">MpUserrecvaddrService</span> <span style="color: #FF8C00;">mpUserrecvaddrService</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testMock</span>() {
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">&#26500;&#24314;&#34394;&#25311;&#23545;&#35937;</span>
        <span style="color: #5FD7FF;">MpUserrecvaddr</span> <span style="color: #FF8C00;">mockAddr</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">MpUserrecvaddr</span>();
        mockAddr.setUraId(<span style="color: #CDC673;">"1"</span>);
        mockAddr.setUserId(<span style="color: #CDC673;">"001"</span>);
        mockAddr.setUraName(<span style="color: #CDC673;">"name_"</span> + 1);
        mockAddr.setUraAddress(<span style="color: #CDC673;">"address_"</span> + 1);
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">&#25351;&#23450; Mock Bean &#26041;&#27861;&#21644;&#21442;&#25968;&#65292;&#24182;&#36820;&#22238;&#34394;&#25311;&#23545;&#35937;</span>
        BDDMockito.given(mpUserrecvaddrService.getById(<span style="color: #CDC673;">"1"</span>)).willReturn(mockAddr);
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">&#36827;&#34892; Mock &#27979;&#35797;</span>
        <span style="color: #5FD7FF;">MpUserrecvaddr</span> <span style="color: #FF8C00;">addr</span> = mpUserrecvaddrService.getById(<span style="color: #CDC673;">"1"</span>);
        System.out.println(<span style="color: #CDC673;">"addr = "</span> + addr);
    }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7ac6337" class="outline-3">
<h3 id="org7ac6337"><span class="section-number-3">3.2.</span> Spring boot + Mockito 的测试实践</h3>
<div class="outline-text-3" id="text-3-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">模块</th>
<th scope="col" class="org-right">版本号</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Springboot</td>
<td class="org-right">2.7.6</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">JUnit4</td>
<td class="org-right">4.13.2</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Powermock</td>
<td class="org-right">2.0.2</td>
<td class="org-left">注意：目前PowerMock只支持JUnit4</td>
</tr>

<tr>
<td class="org-left">Mockito-core</td>
<td class="org-right">3.12.4</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-orgb6188f6" class="outline-4">
<h4 id="orgb6188f6"><span class="section-number-4">3.2.1.</span> maven 包依赖引入</h4>
<div class="outline-text-4" id="text-3-2-1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Spring boot test, Powermock, Mockito-core 依赖引入</label><pre class="src src-xml">&lt;<span style="color: #87D700;">properties</span>&gt;
  &lt;<span style="color: #87D700;">java.version</span>&gt;1.8&lt;/<span style="color: #87D700;">java.version</span>&gt;
  &lt;<span style="color: #87D700;">spring-boot.version</span>&gt;2.7.6&lt;/<span style="color: #87D700;">spring-boot.version</span>&gt;
  &lt;<span style="color: #87D700;">powermock.version</span>&gt;2.0.2&lt;/<span style="color: #87D700;">powermock.version</span>&gt;
  &lt;<span style="color: #87D700;">mockito-core.version</span>&gt;3.12.4&lt;/<span style="color: #87D700;">mockito-core.version</span>&gt;
&lt;/<span style="color: #87D700;">properties</span>&gt;

&lt;<span style="color: #87D700;">dependencies</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.springframework.boot&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;spring-boot-starter-test&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
    &lt;<span style="color: #87D700;">exclusions</span>&gt;
      &lt;<span style="color: #87D700;">exclusion</span>&gt;
        &lt;<span style="color: #87D700;">artifactId</span>&gt;mockito-core&lt;/<span style="color: #87D700;">artifactId</span>&gt;
        &lt;<span style="color: #87D700;">groupId</span>&gt;org.mockito&lt;/<span style="color: #87D700;">groupId</span>&gt;
      &lt;/<span style="color: #87D700;">exclusion</span>&gt;
    &lt;/<span style="color: #87D700;">exclusions</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.powermock&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;powermock-module-junit4&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">version</span>&gt;${powermock.version}&lt;/<span style="color: #87D700;">version</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
    &lt;<span style="color: #87D700;">exclusions</span>&gt;
      &lt;<span style="color: #87D700;">exclusion</span>&gt;
        &lt;<span style="color: #87D700;">artifactId</span>&gt;objenesis&lt;/<span style="color: #87D700;">artifactId</span>&gt;
        &lt;<span style="color: #87D700;">groupId</span>&gt;org.objenesis&lt;/<span style="color: #87D700;">groupId</span>&gt;
      &lt;/<span style="color: #87D700;">exclusion</span>&gt;
    &lt;/<span style="color: #87D700;">exclusions</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.powermock&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;powermock-api-mockito2&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">version</span>&gt;${powermock.version}&lt;/<span style="color: #87D700;">version</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
    &lt;<span style="color: #87D700;">exclusions</span>&gt;
      &lt;<span style="color: #87D700;">exclusion</span>&gt;
        &lt;<span style="color: #87D700;">artifactId</span>&gt;mockito-core&lt;/<span style="color: #87D700;">artifactId</span>&gt;
        &lt;<span style="color: #87D700;">groupId</span>&gt;org.mockito&lt;/<span style="color: #87D700;">groupId</span>&gt;
      &lt;/<span style="color: #87D700;">exclusion</span>&gt;
    &lt;/<span style="color: #87D700;">exclusions</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
  &lt;<span style="color: #87D700;">dependency</span>&gt;
    &lt;<span style="color: #87D700;">groupId</span>&gt;org.mockito&lt;/<span style="color: #87D700;">groupId</span>&gt;
    &lt;<span style="color: #87D700;">artifactId</span>&gt;mockito-core&lt;/<span style="color: #87D700;">artifactId</span>&gt;
    &lt;<span style="color: #87D700;">version</span>&gt;${mockito-core.version}&lt;/<span style="color: #87D700;">version</span>&gt;
    &lt;<span style="color: #87D700;">scope</span>&gt;test&lt;/<span style="color: #87D700;">scope</span>&gt;
  &lt;/<span style="color: #87D700;">dependency</span>&gt;
&lt;/<span style="color: #87D700;">dependencies</span>&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org705a883" class="outline-4">
<h4 id="org705a883"><span class="section-number-4">3.2.2.</span> 测试：获取用户信息接口</h4>
<div class="outline-text-4" id="text-3-2-2">
</div>
<div id="outline-container-org207a609" class="outline-5">
<h5 id="org207a609"><span class="section-number-5">3.2.2.1.</span> 业务代码</h5>
<div class="outline-text-5" id="text-3-2-2-1">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #8B8878;">// </span><span style="color: #8B8878;">User</span>
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">lombok</span>.<span style="color: #5FD7FF;">Data</span>;

<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">javax</span>.<span style="color: #AF87FF;">persistence</span>.<span style="color: #5FD7FF;">Entity</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">javax</span>.<span style="color: #AF87FF;">persistence</span>.<span style="color: #5FD7FF;">Id</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">javax</span>.<span style="color: #AF87FF;">persistence</span>.<span style="color: #5FD7FF;">Table</span>;

<span style="color: #AF87FF;">@Entity</span>
<span style="color: #AF87FF;">@Table</span>(name = <span style="color: #CDC673;">"user"</span>)
<span style="color: #AF87FF;">@Data</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">User</span> {

    <span style="color: #AF87FF;">@Id</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">Long</span> <span style="color: #FF8C00;">id</span>;

    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">name</span>;

    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">Integer</span> <span style="color: #FF8C00;">age</span>;
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">UserDao</span>
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">zrg</span>.<span style="color: #AF87FF;">myspringbootdemo</span>.<span style="color: #AF87FF;">demos</span>.<span style="color: #AF87FF;">entity</span>.<span style="color: #5FD7FF;">User</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">data</span>.<span style="color: #AF87FF;">jpa</span>.<span style="color: #AF87FF;">repository</span>.<span style="color: #5FD7FF;">JpaRepository</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">data</span>.<span style="color: #AF87FF;">jpa</span>.<span style="color: #AF87FF;">repository</span>.<span style="color: #5FD7FF;">JpaSpecificationExecutor</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">stereotype</span>.<span style="color: #5FD7FF;">Repository</span>;

<span style="color: #AF87FF;">@Repository</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">interface</span> <span style="color: #5FD7FF;">UserDao</span> <span style="color: #FF1493;">extends</span> <span style="color: #5FD7FF;">JpaRepository</span>&lt;<span style="color: #5FD7FF;">User</span>, <span style="color: #5FD7FF;">Long</span>&gt;, <span style="color: #5FD7FF;">JpaSpecificationExecutor</span>&lt;<span style="color: #5FD7FF;">User</span>&gt; {
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">UserService</span>
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">zrg</span>.<span style="color: #AF87FF;">myspringbootdemo</span>.<span style="color: #AF87FF;">demos</span>.<span style="color: #AF87FF;">entity</span>.<span style="color: #5FD7FF;">User</span>;

<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">interface</span> <span style="color: #5FD7FF;">UserService</span> {
    <span style="color: #5FD7FF;">User</span> <span style="color: #87D700;">getUserById</span>(<span style="color: #5FD7FF;">Long</span> <span style="color: #FF8C00;">id</span>);
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">UserServiceImpl</span>
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">zrg</span>.<span style="color: #AF87FF;">myspringbootdemo</span>.<span style="color: #AF87FF;">demos</span>.<span style="color: #AF87FF;">entity</span>.<span style="color: #5FD7FF;">User</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">zrg</span>.<span style="color: #AF87FF;">myspringbootdemo</span>.<span style="color: #AF87FF;">demos</span>.<span style="color: #AF87FF;">dao</span>.<span style="color: #5FD7FF;">UserDao</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">zrg</span>.<span style="color: #AF87FF;">myspringbootdemo</span>.<span style="color: #AF87FF;">demos</span>.<span style="color: #AF87FF;">services</span>.<span style="color: #5FD7FF;">MockMapper</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">com</span>.<span style="color: #AF87FF;">zrg</span>.<span style="color: #AF87FF;">myspringbootdemo</span>.<span style="color: #AF87FF;">demos</span>.<span style="color: #AF87FF;">services</span>.<span style="color: #5FD7FF;">UserService</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">lombok</span>.<span style="color: #AF87FF;">extern</span>.<span style="color: #AF87FF;">slf4j</span>.<span style="color: #5FD7FF;">Slf4j</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">beans</span>.<span style="color: #AF87FF;">factory</span>.<span style="color: #AF87FF;">annotation</span>.<span style="color: #5FD7FF;">Autowired</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">springframework</span>.<span style="color: #AF87FF;">stereotype</span>.<span style="color: #5FD7FF;">Service</span>;

<span style="color: #AF87FF;">@Service</span>
<span style="color: #AF87FF;">@Slf4j</span>
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">UserServiceImpl</span> <span style="color: #FF1493;">implements</span> <span style="color: #5FD7FF;">UserService</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">UserDao</span> <span style="color: #FF8C00;">userDao</span>;
    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">MockMapper</span> <span style="color: #FF8C00;">mockMapper</span>;

    <span style="color: #AF87FF;">@Override</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">User</span> <span style="color: #87D700;">getUserById</span>(<span style="color: #5FD7FF;">Long</span> <span style="color: #FF8C00;">id</span>) {
        <span style="color: #FF1493;">if</span> (mockMapper.makeFile(<span style="color: #CDC673;">"/test"</span>)) {
            log.info(<span style="color: #CDC673;">"makeFile success"</span>);
        }
        <span style="color: #FF1493;">return</span> userDao.findById(id).orElse(<span style="color: #AF87FF;">null</span>);
    }
}

<span style="color: #8B8878;">// </span><span style="color: #8B8878;">TestController</span>
<span style="color: #AF87FF;">@RestController</span>
<span style="color: #AF87FF;">@RequestMapping</span>(<span style="color: #CDC673;">"/test"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">TestController</span> {
    <span style="color: #AF87FF;">@PostMapping</span>(<span style="color: #CDC673;">"/getUser"</span>)
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">User</span> <span style="color: #87D700;">getUser</span>(<span style="color: #AF87FF;">@RequestBody</span> <span style="color: #5FD7FF;">GetUserDTO</span> <span style="color: #FF8C00;">getUserDTO</span>) {
        <span style="color: #FF1493;">return</span> userService.getUserById(Long.valueOf(getUserDTO.getUserId()));
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org234ed8e" class="outline-5">
<h5 id="org234ed8e"><span class="section-number-5">3.2.2.2.</span> 测试类</h5>
<div class="outline-text-5" id="text-3-2-2-2">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Test</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #5FD7FF;">Assert</span>;
<span style="color: #FF1493;">import</span> <span style="color: #AF87FF;">org</span>.<span style="color: #AF87FF;">junit</span>.<span style="color: #AF87FF;">runner</span>.<span style="color: #5FD7FF;">RunWith</span>;

<span style="color: #AF87FF;">@RunWith</span>(SpringRunner.<span style="color: #FF1493;">class</span>)
<span style="color: #AF87FF;">@SpringBootTest</span>(webEnvironment = <span style="color: #AF87FF;">SpringBootTest</span>.<span style="color: #AF87FF;">WebEnvironment</span>.RANDOM_PORT)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">TestControllerTest</span> {

    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestRestTemplate</span> <span style="color: #FF8C00;">testRestTemplate</span>;

    <span style="color: #AF87FF;">@MockBean</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">UserDao</span> <span style="color: #FF8C00;">mockUserDao</span>;

    <span style="color: #AF87FF;">@InjectMocks</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">TestController</span> <span style="color: #FF8C00;">testController</span>;

    <span style="color: #AF87FF;">@Before</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">setUp</span>() {
        MockitoAnnotations.openMocks(<span style="color: #FF1493;">this</span>);
    }

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testGetUser</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #5FD7FF;">Long</span> <span style="color: #FF8C00;">userId</span> = 123L;
        <span style="color: #5FD7FF;">User</span> <span style="color: #FF8C00;">expectUser</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">User</span>();
        expectUser.setName(<span style="color: #CDC673;">"&#24352;&#19977;"</span>);
        expectUser.setAge(28);
        expectUser.setId(userId);
        <span style="color: #5FD7FF;">GetUserDTO</span> <span style="color: #FF8C00;">getUserDTO</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">GetUserDTO</span>();
        getUserDTO.setUserId(String.valueOf(userId));

        PowerMockito.when(mockUserDao.findById(Mockito.anyLong())).thenReturn(Optional.of(expectUser));

        <span style="color: #5FD7FF;">ResponseEntity</span>&lt;<span style="color: #5FD7FF;">User</span>&gt; <span style="color: #FF8C00;">result</span> = testRestTemplate.postForEntity(
                                                                     <span style="color: #CDC673;">"/test/getUser"</span>,
                                                                     <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">HttpEntity</span>&lt;&gt;(getUserDTO),
                                                                     User.<span style="color: #FF1493;">class</span>);
        Assert.assertEquals(<span style="color: #AF87FF;">HttpStatus</span>.OK, result.getStatusCode());
        Assert.assertNotNull(result.getBody());
    }
}
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orge485e12" class="outline-2">
<h2 id="orge485e12"><span class="section-number-2">4.</span> 附A-分层自动化测试</h2>
<div class="outline-text-2" id="text-4">
<p>
<b><b>温馨提示：如果急于在项目中做单元测试实践和应用，可以先跳过本章节。</b></b>
<br />
</p>
<ol class="org-ol">
<li>在有了持续交付、自动化测试等基本理念之后，我们梳理一下分层自动化实施的具体方法。</li>
<li>传统的 “集成测试” 更多是通过调用 “接口” 来完成自动化测试用例设计，而并非是单独测试 “接口” 本身。通过调用 “接口” 完成整个后端的业务逻辑测试与 “UI” 自动化测试相同都需要依赖整个后端服务器被正常的加载，且环境 “初始化” 成功。</li>
<li>当实施 UI、API 自动化测试时，团队经常会有一个疑问？为什么 UI 自动化已经保证了业务核心流程的正确性，还需要在通过 API 测试进行 “重复” 的用例开发？从代码覆盖率角度而言，相同的代码逻辑被不用的测试类型覆盖确实没有什么意义。这也引发了对于测试策略的思考，手工、UI、API、Unit 应该如何去分配资源。</li>
<li>通过合理的测试策略的划分减少测试过程种的浪费，这也是DevOps 三步法则之三 “精益” 思想的体现之一。长链路的测试带来测试设计上的难题，比如：用例之间的依赖、测试数据的依赖、环境的依赖等，虽然这些问题都可以通过 “工程化” 方式得以缓解，但是测试用例执行效率、如何精准发现被测代码具体问题依然没有能有效的解决，导致流水线执行失败时排查 “用例问题” 或 “被测代码问题” 的效率极其低下。</li>
</ol>

<p>
<img src="{{site.url}}/assets/images/test/layer-architecture.png" alt="layer-architecture.png" />
<br />
针对上图的技术架构如果要进行分层自动化测试，测试大致可以分为前端测试、后端测试和集成测试。需要注意的是实际项目中后端往往是微服务架构。
</p>
</div>
<div id="outline-container-orgbd24253" class="outline-3">
<h3 id="orgbd24253"><span class="section-number-3">4.1.</span> 前端测试</h3>
<div class="outline-text-3" id="text-4-1">
<ol class="org-ol">
<li>传统的分层自动化测试对 UI 层更多的是使用 Selenium、Playwright、Nightwatch 等 “外置驱动” 的方式开展自动化测试，比如：启动浏览器，进行模拟用户真实的操作。而分层自动的思想是通过 “内置驱动” 的方式通过测试代码驱动研发代码的方式开展自动化测试。前端工程通过分层技术进行拆解之后可以达到独立隔离测试前端以提高持续测试的成功率。</li>
<li>以 Vue 项目为例，分层自动化在前端测试时会将自动化测试分层三个层面。函数级别 JavaScript、组件级别 component、端到端级别 End-to-End。在每一次层测试的重点及使用的技术栈不同。
<ul class="org-ul">
<li>函数级别的测试通常会使用单元测试框架 jest 对函数本身进行测试，通过 “测试数据” 调用函数验证函数的执行逻辑是否符合预期，对于函数内部的调用链通过 jest.mock() 完成隔离。</li>
<li>组件级别的测试通过 Vue 官方的 Vue Test Utils 工具对组件进行浅渲染（shallowMount）只渲染组件的第一层 DOM 结构，其嵌套的子组件不会被渲染出来，从而使得渲染的效率更高，单元测试执行的速度也会更快。</li>
<li>UI(E2E，端到端)自动化测试通过 Mock Server 作为前后端挡板可以实现无需启动后端服务器即可完成前端的 UI 自动化测试，极大的提高了 UI 自动化测试的稳定性，当然UI 自动化测试本身也依赖于被测代码的规范性。</li>
</ul></li>
<li>通过分层自动化使得前端分层测试职责更加明确，也减少了外部依赖。关于函数、组件、端到端，其投入的测试比例可以参考 “测试金字塔模型”。前端分层自动化测试拆分之后如下图所示：
<img src="{{site.url}}/assets/images/test/frontend-auto-testing.png" alt="frontend-auto-testing.png" />
<dl class="org-dl">
<dt>函数测试</dt><dd><p>
通过给定的一组数据校验输入、输出是否符合预期结果，及函数执行是否对其他资源产生了影响。比如：使用 JavaScript 单元测试框架 Jest 进行函数的测试。Jest 可以理解为与 JUnit 5 具有相同的作用。Jest 功能更加齐全，比如：内置函数 mock、代码覆盖率、快照测试等特性。Jest 支持前端主流框架，比如：TypeScript, Node, React, Angular, Vue 等等。使用 Jest 进行单元测试示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;"> * &#20351;&#29992; Mock &#20989;&#25968;&#23450;&#20041; Mock &#20989;&#25968;&#30340;&#23454;&#29616;&#20307;</span>
<span style="color: #CDC673;"> */</span>
test(<span style="color: #CDC673;">'Test Mock function implements'</span>, () =&gt; {
  <span style="color: #FF1493;">let</span> <span style="color: #FF8C00;">sum</span> = jest.fn().mockImplementation(
    () =&gt; {
      console.log(<span style="color: #CDC673;">'mockImplementation function be invoked!'</span>)
      <span style="color: #FF1493;">return</span> <span style="color: #CDC673;">'Miller_'</span> + 30 + <span style="color: #CDC673;">'_Male'</span>
    }
  )
  expect(sum(1, 2, 3)).toMatch(<span style="color: #CDC673;">/Miller/</span>)
})
</pre>
</div></dd>
<dt>组件测试</dt><dd><p>
在 Vue 项目中组件就是一个个.vue 文件，组件包含三大块内容，HTML&lt; template&gt;、CSS&lt; style&gt;、Function&lt; script&gt;。通过模拟行为验证组件的函数、数据、事件是否正确。而不是像单元测试那样直接调用函数验证函数和数据的正确性。相对与单元测试，组件测试需要加载更多的代码进行测试。对于组件的测试通常还需要隔离组件与组件之间的依赖，以及 Mock 组件内部的网络请求等。在 Vue 项目中可以通过 Vue.extend 渲染组件，然后通过构造器挂载组件获取浏览器上下文对象。示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #FF1493;">import</span> Vue from <span style="color: #CDC673;">'vue'</span>
<span style="color: #FF1493;">import</span> HelloWorld from <span style="color: #CDC673;">'@/views/HelloWorld'</span>
describe(<span style="color: #CDC673;">'HelloWorld.vue'</span>, () =&gt; {
  <span style="color: #8B8878;">// </span><span style="color: #8B8878;">Vue &#21019;&#24314;&#24037;&#31243;&#26159;&#33258;&#24102;&#30340;&#27979;&#35797;&#29992;&#20363;</span>
  it(<span style="color: #CDC673;">'should render correct contents'</span>, () =&gt; {
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#36890;&#36807; Vue.extend &#28210;&#26579; HelloWorld &#32452;&#20214;</span>
    <span style="color: #FF1493;">const</span> <span style="color: #FF8C00;">Constructor</span> = Vue.extend(HelloWorld)
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#33719;&#21462;&#27983;&#35272;&#22120;&#19978;&#19979;&#25991;&#23545;&#35937; vm&#65292; &#36825;&#20010; vm &#23545;&#35937;&#21253;&#21547;&#20102; HelloWorld &#32452;&#20214;&#30340;&#25152;&#26377;&#20449;&#24687;</span>
    <span style="color: #FF1493;">const</span> <span style="color: #FF8C00;">vm</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Constructor</span>().$mount()
    expect(vm.$el.querySelector(<span style="color: #CDC673;">'.hello h1'</span>).textContent)
      .toEqual(<span style="color: #CDC673;">'Welcome to Your Vue.js App'</span>)
  })
})
</pre>
</div>
<p>
也可以通过官方的 Vue Test Utils 工具包对组件进行测试，其支持浅渲染（shallowMount）的特性，可以只渲染组件的第一层 DOM 结构，其嵌套的子组件不会被渲染出来，从而使得渲染的效率更高，单元测试执行的速度也会更快，使用 VueTestUtils 工具包测试组件示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#23548;&#20837;Vue Test Utils &#24037;&#20855;&#24211;</span>
<span style="color: #FF1493;">import</span> {shallowMount} from <span style="color: #CDC673;">'@vue/test-utils'</span>
<span style="color: #FF1493;">import</span> HelloWorld from <span style="color: #CDC673;">'@/views/HelloWorld'</span>
describe(<span style="color: #CDC673;">'TestSuite_HelloWorld'</span>, () =&gt; {
  test(<span style="color: #CDC673;">'TestCase_CheckChangeData'</span>, () =&gt; {
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">Given...&#27979;&#35797;&#29992;&#20363;&#21021;&#22987;&#21270;&#30340;&#26465;&#20214;&#21644;&#21021;&#22987;&#29366;&#24577;</span>
    <span style="color: #FF1493;">const</span> <span style="color: #FF8C00;">wrapper</span> = shallowMount(HelloWorld)
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">When...&#25191;&#34892;&#21160;&#20316;</span>
    <span style="color: #FF1493;">const</span> <span style="color: #FF8C00;">message</span> = wrapper.vm.$data.msg
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">Then...&#26029;&#35328;&#21160;&#20316;&#24102;&#26469;&#30340;&#32467;&#26524;</span>
    expect(message).toMatch(<span style="color: #CDC673;">'Welcome'</span>)
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20462;&#25913; data &#23646;&#24615;&#20869;&#23481;</span>
    wrapper.setData({msg: <span style="color: #CDC673;">'Miller'</span>})
    expect(wrapper.vm.$data.msg).toMatch(<span style="color: #CDC673;">'Miller'</span>)
  })
})
</pre>
</div></dd>
<dt>端到端测试</dt><dd><p>
以自然人类的操作方式对被测系统进行模拟点击、输入等行为，校验系统是否符合预期结果。通常这种测试需要依赖被测系统的稳定性，需要使用完整的真实环境进行测试。Vue 创建完之后默认端到端测试工具为 Nightwatch。如果你是一个前端工程师那么使用 Nightwatch 是个不错的选择，它可以将测试代码打包到工程中，方便进行代码协作、版本管理是个非常好的实践，其底层使用的是 selenium 作为测试驱动框架。示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-javascript">module.exports = {
  <span style="color: #CDC673;">'e2e_Login_Page_CheckElement'</span>: <span style="color: #FF1493;">function</span> (<span style="color: #FF8C00;">browser</span>) {
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20351;&#29992; nightwatch.conf.js &#20013;&#30340;&#40664;&#35748;&#22320;&#22336;&#21644;&#31471;&#21475;</span>
    <span style="color: #FF1493;">const</span> <span style="color: #FF8C00;">devServer</span> = browser.globals.devServerURL
    browser
      .url(devServer)
      .waitForElementVisible(<span style="color: #CDC673;">'#app'</span>, 5000)
      .assert.containsText(<span style="color: #CDC673;">'h3'</span>, <span style="color: #CDC673;">'&#25345;&#32493;&#27979;&#35797;-&#20998;&#23618;&#33258;&#21160;&#21270;'</span>)
      .assert.elementCount(<span style="color: #CDC673;">'h3'</span>, 1)
      .end()
  }
}
</pre>
</div>
<p>
如果你是一个测试工程师那么推荐使用 Playwright 进行端到端的自动化测试，它支持一些很方便的特性能够快速、稳定的构建自动化测试用例，比如：智能等待、录制、运行中调试、回放等特性。示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-javascript">@DisplayName(value = <span style="color: #CDC673;">"Playwright&#27979;&#35797;&#31471;&#21040;&#31471;&#29992;&#20363;&#38598;"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> PlaywrightEndToEndTests {
    @DisplayName(<span style="color: #CDC673;">"&#27979;&#35797;&#28155;&#21152;&#32570;&#38519;&#27969;&#31243;"</span>)
    @Test
    <span style="color: #FF1493;">public</span> <span style="color: #FF1493;">void</span> <span style="color: #FF8C00;">testAddIssueFlow</span>() {
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">Given.</span>
        <span style="color: #FF1493;">try</span> (Playwright playwright = Playwright.create(options)) {
            BrowserType.LaunchOptions launchOptions = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">BrowserType.LaunchOptions</span>().setHeadless(<span style="color: #AF87FF;">false</span>).setSlowMo(200);
            <span style="color: #8B8878;">// </span><span style="color: #8B8878;">When.</span>
            Browser browser = playwright.chromium().launch(launchOptions);
            <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#21551;&#29992;&#36861;&#36394;&#21151;&#33021;&#65292;&#36825;&#26679;&#21487;&#20197;&#22312;&#36816;&#34892;&#33258;&#21160;&#21270;&#33050;&#26412;&#20043;&#21518;&#26597;&#30475;&#25972;&#20010;&#25191;&#34892;&#30340;&#36807;&#31243;</span>
            BrowserContext context = browser.newContext();
            context.tracing().start(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Tracing.StartOptions</span>().setScreenshots(<span style="color: #AF87FF;">true</span>).setSnapshots(<span style="color: #AF87FF;">true</span>).setSources(<span style="color: #AF87FF;">true</span>));
            Page page = context.newPage();
            page.navigate(url);
            <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#23450;&#20301;&#20803;&#32032;</span>
            page.locator(<span style="color: #CDC673;">"#username"</span>).fill(<span style="color: #CDC673;">"admin@aliyun.com"</span>);
            page.locator(<span style="color: #CDC673;">"button.el-button.submit.el-button--primary"</span>).click();
            <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#36339;&#36716;&#21040;&#32570;&#38519;&#21015;&#34920;</span>
            page.navigate(url + <span style="color: #CDC673;">"/issues/list"</span>);
            page.locator(<span style="color: #CDC673;">"#addIssue"</span>).click();
            page.locator(<span style="color: #CDC673;">"#issueTitle"</span>).fill(<span style="color: #CDC673;">"playwright test by Miller"</span>);
            page.locator(<span style="color: #CDC673;">"#issueHandler"</span>).click();
           page.locator(<span style="color: #CDC673;">"li[id=\"miller.shan@aliyun.com\"]"</span>).click();
            page.locator(<span style="color: #CDC673;">"#submit"</span>).click();
            <span style="color: #8B8878;">// </span><span style="color: #8B8878;">Then</span>
            assertThat(page.content(), Matchers.containsStringIgnoringCase(<span style="color: #CDC673;">"playwright test by Miller"</span>));
            <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#26242;&#20572;&#21551;&#21160;&#35843;&#35797;&#12289;&#24405;&#21046;&#27169;&#24335;</span>
            page.pause();
            context.tracing().stop(<span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Tracing.StopOptions</span>().setPath(Paths.get(<span style="color: #CDC673;">"trace.zip"</span>)));
        }
    }
}
</pre>
</div></dd>
</dl></li>
<li>综上，得出前端测试的渐进性图：
<img src="{{site.url}}/assets/images/test/unit-test.jpg" alt="unit-test.jpg" /></li>
</ol>
<p>
<br />
通过以上技术方案可以实现前端的分层自动化测试，但是这里需要注意的一点是当执行端到端自动化测试时由于需要依赖后端服务正常运行，所以需要使用 MockServer 技术进行前后端隔离。
<br />
为了在端到端的自动化测试过程中正确断言，保证后台服务器处于正常运行状态是必备的，前端开发、测试往往会因为后端的实现进度而滞后，而由于团队中数据的公用也会影响效率。
</p>
<ul class="org-ul">
<li>比较理想的前后端分离研发，后端在项目初期就已将表结构定义完成，配套生成了 Java Bean 对象，并且将接口定义完成，提供至少一个 Mock 的数据返回；</li>
<li>前端可以根据 Swagger 自动生成的文档进行联调，随着后端接口的逐步完成，前端也与之同步，达到业务逻辑的同步实现。</li>
<li>当出现前端需要一个新的接口，后端还没有该接口的定义和实体的开发时，前端可以根据原型设计进行前端静态页面的开发，通过使用 Mock 技术来访问一个非真实的服务端接口。这样就可以在不依赖后端服务器，进行独立的前端开发及测试。</li>
</ul>
<p>
<br />
其内部处理流程可以参考如下图：
<img src="{{site.url}}/assets/images/test/internal-handle-flow.png" alt="internal-handle-flow.png" />
MockServer 不单单可以作为前后端隔离服务，而且也可以用于后端的微服务隔离，它不但支持 JSON 文件数据的方式作为响应数据，而且也支持代码的方式，比如：通过 JUnit 方式对微服务之前的调用进行隔离。也可以作为一个代理服务器用于代理负载均衡器 (比如 Nginx)。作为代理服务其状态流程如下图：
<img src="{{site.url}}/assets/images/test/proxy-service-status-flow.png" alt="proxy-service-status-flow.png" />
</p>
</div>
</div>
<div id="outline-container-orgbc5a1e4" class="outline-3">
<h3 id="orgbc5a1e4"><span class="section-number-3">4.2.</span> 后端测试</h3>
<div class="outline-text-3" id="text-4-2">
<p>
后端根据被测系统的架构可以拆分为 Mapper、Service、Controller 等层测试，其分层策略大概如下图：
<img src="{{site.url}}/assets/images/test/backend-auto-testing.png" alt="backend-auto-testing.png" />
</p>
<dl class="org-dl">
<dt>Mapper 测试</dt><dd><p>
对于 Mapper 层的测试更多的是关注与 SQL 语句的正确性，还有就是如果使用了动态 SQL 特性，那么需要校验不同分支的逻辑正确性。Mapper 测试可以使用 mybatis-config-test.xml 文件配置数据源，然后使用原生的 SqlSessionFactory 创建与数据库的 session 连接，进而完成 CRUD 的操作。这种方式的在于无需依赖 SpringBoot 即可完成 Mapper 层的测试。示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#20351;&#29992;&#32431;Java&#20195;&#30721;&#27979;&#35797;Mapper&#23618;&#25509;&#21475;&#21450;Xml"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">CalculatorHasDBMapperTestByJavaCodeTests</span> {
    <span style="color: #FF1493;">private</span> <span style="color: #FF1493;">static</span> <span style="color: #5FD7FF;">SqlSession</span> <span style="color: #FF8C00;">sqlSession</span>;
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorHasDBMapper</span> <span style="color: #FF8C00;">mapper</span>;
    <span style="color: #AF87FF;">@BeforeAll</span>
    <span style="color: #FF1493;">public</span> <span style="color: #FF1493;">static</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">beforeAll</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">IOException</span> {
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#20174; mybatis-config-test.xml &#35835;&#21462; MyBatis &#37197;&#32622;</span>
        <span style="color: #5FD7FF;">Reader</span> <span style="color: #FF8C00;">reader</span> = Resources.getResourceAsReader(<span style="color: #CDC673;">"mybatis-config-test.xml"</span>);
        <span style="color: #5FD7FF;">SqlSessionFactory</span> <span style="color: #FF8C00;">sqlSessionFactory</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">SqlSessionFactoryBuilder</span>().build(reader);
        sqlSession = sqlSessionFactory.openSession();
    }
    <span style="color: #AF87FF;">@AfterAll</span>
    <span style="color: #FF1493;">public</span> <span style="color: #FF1493;">static</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">afterAll</span>() {
        sqlSession.close();
    }
    <span style="color: #AF87FF;">@BeforeEach</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">beforeEach</span>() {
        mapper = sqlSession.getMapper(CalculatorHasDBMapper.<span style="color: #FF1493;">class</span>);
    }
    <span style="color: #AF87FF;">@AfterEach</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">afterEach</span>() {
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#23558;&#20462;&#25913;&#25552;&#20132;&#21040;&#25968;&#25454;&#24211;&#65292;&#19981;&#25552;&#20132;&#21017;&#25968;&#25454;&#24211;&#19981;&#29983;&#25928;&#65292;&#22914;&#26524;&#20165;&#20165;&#21482;&#26159;&#27979;&#35797; Mapper &#25509;&#21475;&#21487;&#20197;&#19981;&#25552;&#20132;</span>
        sqlSession.commit();
    }
<span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#27979;&#35797;Insert&#35821;&#21477;"</span>)
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testInsert</span>() {
        <span style="color: #5FD7FF;">Calculator</span> <span style="color: #FF8C00;">calculator</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Calculator</span>();
        calculator.setFirstNumber(1.0);
        calculator.setSecondNumber(2.0);
        calculator.setResult(3.0);
        <span style="color: #5FD7FF;">Integer</span> <span style="color: #FF8C00;">insert</span> = mapper.insert(calculator);
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">System.out.println(calculator.getId());</span>
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#26029;&#35328;&#24433;&#21709;&#30340;&#35760;&#24405;&#25968;&#25454;&#20026;1</span>
        assertThat(insert, Matchers.is(1));
    }
}
</pre>
</div>
<p>
第二种方式是通过 MyBatis 官方提供的@MybatisTest注解测试 MyBatis，使用@MybatisTest注解会自动配置 SqlSessionFactory，并且自动配置一个内存数据库。使用@MyBatisTest注解编写的测试用例在测试结束时会自动进行事务的回滚，而且@MybatisTest运行时是不会加载其他的 Bean 组件到当前测试用例。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@MybatisTest</span>
<span style="color: #AF87FF;">@AutoConfigureTestDatabase</span>(replace = <span style="color: #AF87FF;">AutoConfigureTestDatabase</span>.<span style="color: #AF87FF;">Replace</span>.NONE)
<span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#20351;&#29992;@MyBatisTest&#27979;&#35797;Mapper"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">CalculatorHasDBMapperTestByMyBatisTestAnnotationTests</span> {
    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorHasDBMapper</span> <span style="color: #FF8C00;">calculatorHasDBMapper</span>;
    <span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#27979;&#35797;Insert&#35821;&#21477;"</span>)
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testInsert</span>() {
        <span style="color: #5FD7FF;">Calculator</span> <span style="color: #FF8C00;">calculator</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Calculator</span>();
        calculator.setFirstNumber(1.0);
        calculator.setSecondNumber(2.0);
        calculator.setResult(3.0);
        <span style="color: #5FD7FF;">Integer</span> <span style="color: #FF8C00;">insert</span> = calculatorHasDBMapper.insert(calculator);
        assertThat(insert, Matchers.is(1));
    }
}
</pre>
</div>
<p>
第三种方式是通过 Spring 的事务功能进行 Mapper 的测试。使用 @Transactional 的方式数据并不会真实入库，可以理解为之前用纯 Java 代码的 SqlSession 的方式不做 commit，主键自增 ID 会被使用掉了，但数据会被回滚，这是事务的默认行为。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@Transactional</span>
<span style="color: #AF87FF;">@SpringBootTest</span>
<span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#20351;&#29992;Spring&#30340;&#20107;&#21153;Transaction&#38548;&#31163;&#25968;&#25454;"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">CalculatorHasDBMapperTestByTransactionTests</span> {
    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorHasDBMapper</span> <span style="color: #FF8C00;">calculatorHasDBMapper</span>;
    <span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#27979;&#35797;Insert&#35821;&#21477;"</span>)
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testInsert</span>() {
        <span style="color: #5FD7FF;">Calculator</span> <span style="color: #FF8C00;">calculator</span> = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">Calculator</span>();
        calculator.setFirstNumber(1.0);
        calculator.setSecondNumber(2.0);
        calculator.setResult(3.0);
        <span style="color: #5FD7FF;">Integer</span> <span style="color: #FF8C00;">insert</span> = calculatorHasDBMapper.insert(calculator);
        assertThat(insert, Matchers.is(1));
    }
}
</pre>
</div>
<p>
第四种方式是使用 H2 Database 内存数据库，通过将数据源切换到 application-h2.properties 配置的方式让所有测试数据都指向内存数据库，通过会结合 flyway 一起使用，使用这种方式对于 SQL 语句的语法有一定要求。示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@ActiveProfiles</span>(<span style="color: #CDC673;">"h2"</span>)
<span style="color: #AF87FF;">@SpringBootTest</span>
<span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#20351;&#29992;&#20869;&#23384;&#25968;&#25454;&#24211;H2"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">CalculatorHasDBMapperTestByH2Tests</span> {
    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorHasDBMapper</span> <span style="color: #FF8C00;">calculatorHasDBMapper</span>;
    <span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#27979;&#35797;Select&#35821;&#21477;"</span>)
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testSelect</span>() {
        <span style="color: #5FD7FF;">List</span>&lt;<span style="color: #5FD7FF;">Calculator</span>&gt; <span style="color: #FF8C00;">select</span> = calculatorHasDBMapper.getCalculatorList();
        assertThat(select.size(), Matchers.greaterThanOrEqualTo(0));
        <span style="color: #8B8878;">//</span><span style="color: #8B8878;">select.forEach(System.out::println);</span>
    }
}
</pre>
</div></dd>
<dt>Controller 测试</dt><dd><p>
对于 Controller 层测试的重点应该关注于输入数据的正确性校验，以及返回数据的结构是否正确即可。因为 Controller 层调用的 Service 已经在 Service 层进行单元验证了。同理 Controller 层也是一个普通的 Java 类，所以我们可以通过 Mock 的方式把它当作普通类进行测试，但是这样就会丢失 HTTP 服务器的数据报文。将 Controller 作为普通 Java 类测试示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"&#27979;&#35797;&#35745;&#31639;&#22120;Controller&#23618;&#20195;&#30721;"</span>)
<span style="color: #AF87FF;">@ExtendWith</span>(MockitoExtension.<span style="color: #FF1493;">class</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">CalculatorControllerTestByMockitoTests</span> {
    <span style="color: #AF87FF;">@InjectMocks</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorController</span> <span style="color: #FF8C00;">calculatorController</span>;
    <span style="color: #AF87FF;">@Mock</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorServiceImpl</span> <span style="color: #FF8C00;">calculatorService</span>;
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#27979;&#35797;&#25968;&#25454;</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">Calculator</span> <span style="color: #FF8C00;">calculator</span>;
    <span style="color: #CDC673;">/**</span>
<span style="color: #CDC673;">     * &#30452;&#25509;&#35843;&#29992; Controller &#23545;&#35937;&#30340;&#26041;&#27861;&#65292;&#25226; Controller &#24403;&#26222;&#36890;&#31867;&#36827;&#34892;&#27979;&#35797;&#65292;&#32780;&#19981;&#26159; HTTP &#25509;&#21475;</span>
<span style="color: #CDC673;">     */</span>
    <span style="color: #AF87FF;">@DisplayName</span>(value = <span style="color: #CDC673;">"&#27979;&#35797;Restful&#30340;POST&#26041;&#27861;&#65292;&#21442;&#25968;&#20026;JSON"</span>)
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testPostMethod</span>() {
        when(calculatorService.add(anyDouble(), anyDouble())).thenReturn(calculator);
        assertAll(
                <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#26500;&#36896;POST&#26041;&#27861;&#35831;&#27714;&#21442;&#25968;, &#31532;&#19968;&#31181;&#24773;&#20917;:&#20256;null</span>
                () -&gt; {
                    <span style="color: #5FD7FF;">String</span> <span style="color: #FF8C00;">nullObject</span> = calculatorController.testPostMethod(<span style="color: #AF87FF;">null</span>);
                    assertThat(nullObject, equalToIgnoringCase(<span style="color: #CDC673;">"Request body can't be empty."</span>));
                };
    }
}
</pre>
</div>
<p>
第二种方式是使用 SpringBoot 中提供了@WebMvcTest 注解可以单独注入需要测试的 Controller，通过 MockMvc 模拟客户端发送请求到服务器，然后通过@MockBean注解 Mock 具体 Service 方法的行为，进而达到单独对 Controller 测试的目的。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #FF1493;">package</span> com.github.millergo.<span style="color: #AF87FF;">controller</span>;
<span style="color: #AF87FF;">@WebMvcTest</span>(value = {CalculatorController.<span style="color: #FF1493;">class</span>})
<span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"Test CalculatorController by @WebMvcController"</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">CalculatorControllerTestByWebMvcTestTests</span> {
    <span style="color: #AF87FF;">@MockBean</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorServiceImpl</span> <span style="color: #FF8C00;">calculatorService</span>;
    <span style="color: #AF87FF;">@Autowired</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">MockMvc</span> <span style="color: #FF8C00;">mockMvc</span>;
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">Calculator</span> <span style="color: #FF8C00;">calculator</span>;
    <span style="color: #AF87FF;">@DisplayName</span>(<span style="color: #CDC673;">"Test RESTFul GET Method"</span>)
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testGetMethod</span>() <span style="color: #FF1493;">throws</span> <span style="color: #5FD7FF;">Exception</span> {
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">Stubbing, &#38548;&#31163; Service</span>
        when(calculatorService.add(anyDouble(), anyDouble())).thenReturn(calculator);
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">MockMvc &#25317;&#26377; Client &#33021;&#21147;&#65292;&#21487;&#20197;&#23545;&#26381;&#21153;&#22120;&#21457;&#36865;&#35831;&#27714;</span>
        <span style="color: #5FD7FF;">ResultActions</span> <span style="color: #FF8C00;">resultActions</span> = mockMvc.perform(MockMvcRequestBuilders.get(<span style="color: #CDC673;">"/calc/add/1/2"</span>));
resultActions.andExpect(MockMvcResultMatchers.status().isOk())
resultActions.andDo(MockMvcResultHandlers.print());
    }
}
</pre>
</div>
<p>
对于Controller 层的测试推荐使用@WebMvcTest注解进行测试，当然使用@SpringBootTest、REST-Assured 等其他方式也支持测试 Controller。
</p></dd>
<dt>Service 测试</dt><dd><p>
Service 层测试是整个后端最重要的测试层，其关乎后端系统业务的正确性，在实际项目中大部分的后端测试都是在校验 Service 的正确性。目前大部分团队在进行 SpringBoot 单元测试基本上就是使用@SpringBootTest注解标注进行，这种方式测试用例执行期间会启动 Spring IOC 容器加载所有依赖的 Bean 对象，并且自动注入所有对象，测试用例通过调用 Service 层的方法进行单元测试，这样做带来的弊端是测试用例执行时需要被依赖的所有服务均处于正常运行，现在微服务下很多 RPC 的调用，我们以为是调用一个方法，实际可能调用了成千上万的服务。并且需要保证 Service 依赖的数据库、Kafka、Redis 等都正常运行，否则测试用例很可能导致失败。而分层自动化测试则不同，分层自动化通过 Test Double(测试替身) 的方式对 Service 进行隔离，通过 Mock 技术可以单独针对某一个方法甚至是某一行代码行进行单独的测试，而不依赖于方法内部的调用链路。由于 Mapper 层我们已经单独对其进行了测试，所以测试 Service 层时完全可以自己构造测试数据，Mock 掉 Mapper 层的依赖，达到独立测试 Service。Service 层测试可以使用 Mockito、PowerMock、spring-test 等技术手段。比如：下面的代码使用 spring-test 结合 Mockito 进行一个简单的计算器测试示例代码。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@ExtendWith</span>(MockitoExtension.<span style="color: #FF1493;">class</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">UseMockitoInJunit5ByAnnotation</span> {
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorServiceImpl</span> <span style="color: #FF8C00;">calculatorService</span>;
    <span style="color: #AF87FF;">@Mock</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorMapper</span> <span style="color: #FF8C00;">mockCalculatorMapper</span>;
    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testGetCalcResultUseMockito</span>() {
        <span style="color: #FF1493;">this</span>.calculatorService = <span style="color: #FF1493;">new</span> <span style="color: #5FD7FF;">CalculatorServiceImpl</span>();
        ReflectionTestUtils.setField(calculatorService, <span style="color: #CDC673;">"calculatorMapper"</span>, mockCalculatorMapper);
Mockito.when(mockCalculatorMapper.getCalcResultByDesc(<span style="color: #CDC673;">"desc"</span>)).thenReturn(4.0);
        calculatorService.getCalcResult(<span style="color: #CDC673;">"desc"</span>);
        <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#39564;&#35777; Mock &#30340;&#23545;&#35937; CalculatorMapper &#34987;&#35843;&#29992;&#30340;&#27425;&#25968;&#20026;1</span>
        Mockito.verify(mockCalculatorMapper, Mockito.times(1)).getCalcResultByDesc(<span style="color: #CDC673;">"desc"</span>);
    }
}
</pre>
</div>
<p>
CalculatorServiceImpl 里需要注入 CalculatorMapper 所以这里需要借助 Spring-test 的反射测试工具来实现将 Mock 出来的 CalculatorMapper 注入到 CalculatorServiceImpl 类中。当然也可以不使用 spring-test 包的反射工具类注入对象而使用 Mockito 的@InjectMocks注解自动注入 CalculatorServiceImpl 的一个 Mock 对象。示例代码如下：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #AF87FF;">@ExtendWith</span>(MockitoExtension.<span style="color: #FF1493;">class</span>)
<span style="color: #FF1493;">public</span> <span style="color: #FF1493;">class</span> <span style="color: #5FD7FF;">MockitoInjectMocksTests</span> {
    <span style="color: #8B8878;">// </span><span style="color: #8B8878;">&#23558; @Mock &#27880;&#35299;&#30340;&#23545;&#35937;&#27880;&#20837;&#21040; @InjectMocks &#23545;&#35937;&#20013;&#30340;&#23646;&#24615;</span>
    <span style="color: #AF87FF;">@InjectMocks</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorServiceImpl</span> <span style="color: #FF8C00;">calculatorService</span>;
    <span style="color: #AF87FF;">@Mock</span>
    <span style="color: #FF1493;">private</span> <span style="color: #5FD7FF;">CalculatorMapper</span> <span style="color: #FF8C00;">mockCalculatorMapper</span>;

    <span style="color: #AF87FF;">@Test</span>
    <span style="color: #FF1493;">public</span> <span style="color: #5FD7FF;">void</span> <span style="color: #87D700;">testInjectMocks</span>() {
       calculatorService.getCalcResult(<span style="color: #AF87FF;">null</span>);
    }
}
</pre>
</div>
<p>
InjectMocks 注解会尝试通过构造方法自动注入需要的 Mock 对象，如果没有构造方法，则会使用 setXxx() 尝试进行注入。在后面的实践章节将详细介绍使用方法。
</p></dd>
</dl>
</div>
</div>
<div id="outline-container-orgbaf7753" class="outline-3">
<h3 id="orgbaf7753"><span class="section-number-3">4.3.</span> 集成测试</h3>
<div class="outline-text-3" id="text-4-3">
<ol class="org-ol">
<li>集成测试的 “集成 “是一个相对概念，一般我们将测试会分为几个级别，单元测试、集成测试、系统测试、验收测试等。</li>
<li>集成测试更多指的是在单元被组合在一起之后的测试。比如：方法之间的集成、类之间的集成、模块之间的集成、微服务之间的集成、服务与中间件的集成、前后端的集成、系统之间的集成等。在上面的前端测试中组件测试和端到端测试可以理解为是一种集成测试。后端测试中对 Controller 使用 REST-Assured 也可以理解为是一种集成测试。</li>
<li>在集成测试中更多关注的是模块之间组合在一起之后的正确性。如果直接使用 Postman、HttpClient、REST-Assured 就可以认为是后端的集成测试或者叫服务端测试。但是如果只是想测试 Controller 与 Service 之间的集成测试，那么则需要隔离 Mapper，这种方式通常在调式中完成，而非自动化的集成测试，或者使用 H2 Database 进行后端的集成测试。
<img src="{{site.url}}/assets/images/test/integration-auto-testing.png" alt="integration-auto-testing.png" /></li>
</ol>
</div>
</div>
<div id="outline-container-orgd334b83" class="outline-3">
<h3 id="orgd334b83"><span class="section-number-3">4.4.</span> 分层测试架构</h3>
<div class="outline-text-3" id="text-4-4">
<p>
通过使用分层自动化中的这些技术能有有效的进行 “真正” 分层自动化测试，但是对于传统的端到端测试、服务端测试也是有其价值的，具体还需要根据项目及团队进行取舍。传统的分层自动化与分层自动化也可以通过配置化的方式选择是否使用测试替身 Test Double 的切换，不过这个属于测试框架、测试平台层面需要去配合实现。关于分层自动化测试架构完整图可以参考如下：
<img src="{{site.url}}/assets/images/test/layer-auto-testing-architecture.png" alt="layer-auto-testing-architecture.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org4f6ce7d" class="outline-2">
<h2 id="org4f6ce7d"><span class="section-number-2">5.</span> 附B-开发模式</h2>
<div class="outline-text-2" id="text-5">
<dl class="org-dl">
<dt>TDD</dt><dd><p>
测试驱动开发，英文为 Testing Driven Development，强调的是一种开发方式，以测试来驱动整个项目，即先根据接口完成测试编写，然后在完成功能是要不断通过测试，最终目的是通过所有测试。本质上，我们重复遵循三个简单的步骤：
</p>
<ol class="org-ol">
<li>为要添加的下一个功能编写测试。</li>
<li>编写功能代码直到测试通过。</li>
<li>重构新旧代码以使其结构良好。</li>
</ol>

<div id="org3363ea4" class="figure">
<p><img src="{{site.url}}/assets/images/test/test-driven-development.png" alt="test-driven-development.png" />
</p>
</div>

<div id="org42f410f" class="figure">
<p><img src="{{site.url}}/assets/images/test/tdd.jpg" alt="tdd.jpg" />
</p>
</div></dd>
<dt>BDD</dt><dd>行为驱动开发，英文为 Behavior Driven Development，BDD 的核心价值是体现在正确的对系统行为进行设计，所以它并非一种行之有效的测试方法。它强调的是系统最终的实现与用户期望的行为是一致的、验证代码实现是否符合设计目标。但是它本身并不强调对系统功能、性能以及边界值等的健全性做保证，无法像完整的测试一样发现系统的各种问题。但 BDD 倡导的用简洁的自然语言描述系统行为的理念，可以明确的根据设计产生测试，并保障测试用例的质量。
<img src="{{site.url}}/assets/images/test/bdd.jpg" alt="bdd.jpg" /></dd>
<dt>ATDD</dt><dd>验收测试驱动开发，英文为 Acceptance Test Driven Development，通过单元测试用例来驱动功能代码的实现，团队需要定义出期望的质量标准和验收细则，以明确而且达成共识的验收测试计划（包含一系列测试场景）来驱动开发人员的TDD实践和测试人员的测试脚本开发。面向开发人员，强调如何实现系统以及如何检验。</dd>
<dt>DDD</dt><dd><p>
Domain-drive Design,领域驱动设计。其目的是以一种领域专家、设计人员、开发人员都能理解的通用语言作为相互交流的工具，在交流的过程中发现领域概念，然后将这些概念设计成一个领域模型，再有该模型驱动软件设计和开发。
<img src="{{site.url}}/assets/images/test/ddd.jpg" alt="ddd.jpg" />
<b><b>领域模型：</b></b>
</p>
<ul class="org-ul">
<li>领域模型是是对具有某个边界的领域的一个抽象，反映了领域内用户需求的本质</li>
<li>领域模型只反映业务，和技术无关</li>
<li>领域模型可以反映领域中的实体和过程</li>
<li>领域模型确保业务逻辑都在一个模型中，有助于提高应用的维护性和可重用性</li>
<li>领域模型可以让开发人员相对平滑地将业务知识转换为软件架构</li>
<li>领域模型贯穿软件分析、设计，以及开发的整个过程</li>
<li>建立正确的领域模型需要领域专家、设计、开发人员积极沟通共同努力，是大家对领域内的业务不断深入，从而不断细化和完善领域模型</li>
<li>领域模型的表达方式有多种</li>
<li>领域模型是整个软件的核心，设计足够精良且符合业务需求的领域模型能够更快速的响应需求变化</li>
</ul>
<p>
<b><b>领域驱动设计的分成架构：</b></b>
</p>
<ul class="org-ul">
<li>用户界面/表现层</li>
<li>应用层</li>
<li>领域层 - 表达业务概念，业务信息和业务规则</li>
<li>基础设施层</li>
</ul>
<p>
<b><b>业务对象的职责和策略：</b></b>
</p>
<ul class="org-ul">
<li>实体（Entities）：具备唯一ID，能够被持久化，具备业务逻辑，对应业务对象</li>
<li>值对象（Value objects）：不具有唯一ID，由对象的属性描述，一般为内存中的临时对象，可以用来传递参数或对实体进行补充描述。</li>
<li>工厂（Factories）：主要用来创建实体，目前架构实践中一般采用IOC容器来实现工厂的功能</li>
<li>仓库（Repositories）：用来管理实体的集合，封装持久化框架</li>
<li>服务（Services）：为上层建筑提供可操作的接口，负责对领域对象进行调度和封装，同时可以对外提供各种形式的服务</li>
</ul></dd>
</dl>
<p>
<br />
<b><b>TDD 和 BDD 有各自的使用场景，BDD 一般偏向于系统功能和业务逻辑的自动化测试设计；而 TDD 在快速开发并测试功能模块的过程中则更加高效，以快速完成开发为目的。DDD 则较为复杂</b></b>
</p>

<div id="org2203bcf" class="figure">
<p><img src="{{site.url}}/assets/images/test/mixing-dev.jpg" alt="mixing-dev.jpg" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgeca476d" class="outline-2">
<h2 id="orgeca476d"><span class="section-number-2">6.</span> 附C-参考资料</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><a href="https://github.com/junit-team/junit4/wiki">https://github.com/junit-team/junit4/wiki</a></li>
<li><a href="https://github.com/powermock/powermock/wiki/Mockito">Official: Using PowerMock with Mockito</a></li>
<li><a href="https://www.pdai.tech/md/develop/ut/dev-ut-unit-test.html">单元测试 - 浅谈单元测试</a></li>
<li><a href="https://janycode.github.io/2021/03/23/09_%E8%B0%83%E8%AF%95%E6%B5%8B%E8%AF%95/02_%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/03-SpringBoot%E9%9A%8F%E6%9C%BA%E7%AB%AF%E5%8F%A3%E5%92%8CMock%E6%B5%8B%E8%AF%95/">SpringBoot随机端口和Mock测试</a></li>
<li><a href="https://blog.csdn.net/wwd0501/article/details/104216427">PowerMock使用详解</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/598857010">用PowerMock写Java单元/集成测试</a></li>
<li><a href="https://martinfowler.com/bliki/TestDrivenDevelopment.html">Test Driven Development</a></li>
<li><a href="https://testerhome.com/topics/36401/show_wechat">持续交付下的分层自动化测试</a></li>
<li><a href="https://medium.datadriveninvestor.com/the-value-at-the-intersection-of-tdd-ddd-and-bdd-da58ea1f3ac8">The Value at the Intersection of TDD, DDD, and BDD</a></li>
</ul>
</div>
</div>
